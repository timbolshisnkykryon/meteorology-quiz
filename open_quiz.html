<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מבחן שאלות פתוחות במטאורולוגיה</title>
    <!-- טעינת Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- טעינת גופן Rubik (מתאים יותר לעברית מהדוגמה) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* הגדרת גופן ברירת מחדל */
        body {
            font-family: 'Rubik', sans-serif;
        }

        .question-index-wrapper {
            background-color: #f1f5f9;
            border: 1px solid #cbd5f5;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .question-index-wrapper h2 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.75rem;
        }

        .question-index-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            max-height: 10rem;
            overflow-y: auto;
            padding: 0.25rem;
        }

        .question-index-btn {
            width: 2.75rem;
            height: 2.75rem;
            border-radius: 9999px;
            border: 1px solid #cbd5f5;
            background-color: #f8fafc;
            color: #0f172a;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .question-index-btn:hover {
            background-color: #e2e8f0;
        }

        .question-index-btn.is-active {
            background-color: #1d4ed8;
            border-color: #1e3a8a;
            color: #ffffff;
            box-shadow: 0 10px 18px -10px rgba(29, 78, 216, 0.6);
        }

        .question-index-btn.is-in-progress {
            background-color: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .question-index-btn.is-answered {
            background-color: #bae6fd;
            border-color: #0284c7;
            color: #0c4a6e;
        }

        #standalone-nav {
            margin-bottom: 1rem;
        }

        #standalone-nav a {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #0f172a;
            color: #ffffff;
            padding: 0.65rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }

        #standalone-nav a:hover {
            background-color: #1e293b;
        }

        /* סגנון לספינר טעינה */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* סגנון לתשובה המלאה כדי לשמור על מעברי שורה */
        .whitespace-pre-line {
            white-space: pre-line;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-4xl mx-auto">
        
        <!-- כותרת ומונה שאלות -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 pb-4 border-b">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">מבחן שאלות פתוחות במטאורולוגיה</h1>
            <div class="flex items-center gap-3">
                <button type="button"
                        onclick="shuffleQuestions()"
                        class="inline-flex items-center gap-2 bg-teal-100 text-teal-800 font-semibold py-2 px-3 rounded-lg hover:bg-teal-200 transition-colors duration-200">
                    ערבב/י שאלות
                </button>
                <div id="question-counter" class="text-lg font-semibold text-gray-600 bg-gray-100 px-3 py-1 rounded-full"></div>
            </div>
        </div>

        <div id="standalone-nav" class="hidden">
            <a href="index.html" aria-label="חזרה לתפריט הראשי">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
                חזרה לתפריט הראשי
            </a>
        </div>

        <div class="question-index-wrapper" aria-label="ניווט מהיר בין השאלות">
            <h2>ניווט מהיר בין השאלות</h2>
            <div id="question-index" class="question-index-container" role="navigation"></div>
        </div>

        <!-- אזור השאלה -->
        <div id="quiz-container">
            <h2 id="term" class="text-3xl font-bold text-gray-900 mb-4"></h2>
            <p class="text-md font-semibold text-blue-700 mb-5">ענה/י על כל סעיפי השאלה:</p>
            <div id="sub-questions" class="text-lg text-gray-800 mb-5 space-y-2 rtl"></div>


            <!-- שדה תשובה -->
            <textarea id="user-answer"
                      class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                      placeholder="הקלד/י את תשובתך המלאה (לכל הסעיפים) כאן..."></textarea>

            <!-- כפתור הגשה -->
            <button id="submit-btn"
                    onclick="submitAnswer()"
                    class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                בדוק את תשובתי (עם Gemini)
            </button>

            <!-- אזור משוב וטעינה -->
            <div id="feedback-container" class="mt-4 min-h-[50px] p-3 bg-gray-50 rounded-lg hidden flex items-center justify-center">
                <div id="loader" class="loader hidden"></div>
                <p id="feedback" class="text-md font-medium text-gray-700 whitespace-pre-line"></p>
            </div>

            <div id="reset-actions" class="mt-4 flex flex-col md:flex-row md:items-center gap-2 hidden">
                <button id="retry-btn"
                        type="button"
                        onclick="retryQuestion()"
                        class="w-full md:w-auto bg-white border border-blue-500 text-blue-600 font-semibold py-2 px-4 rounded-lg hover:bg-blue-50 transition-colors duration-200">
                    נסה/י שוב את השאלה הזו
                </button>
                <button id="reset-quiz-btn"
                        type="button"
                        onclick="restartQuiz()"
                        class="w-full md:w-auto bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition-colors duration-200">
                    אפס/י את כל המבחן
                </button>
            </div>

            <!-- אזור תשובה נכונה (מוסתר) -->
            <div id="correct-answer-container" class="mt-6 hidden border-t pt-4">
                <button id="show-answer-btn"
                        onclick="showAnswer()"
                        class="text-sm text-blue-600 hover:underline mb-3 font-medium">
                    הצג/הסתר תשובה מלאה
                </button>
                
                <div id="correct-answer" class="hidden bg-green-50 border border-green-200 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-green-800">תשובת מודל (מבוססת חומר הקורס):</h3>
                    <p id="definition" class="text-md text-green-900 mb-3 whitespace-pre-line"></p>
                    
                    <h3 class="text-lg font-bold text-green-800">הסבר והרחבה:</h3>
                    <p id="explanation" class="text-md text-green-900 mb-3 whitespace-pre-line"></p>
                    
                    <h3 class="text-lg font-bold text-green-800">טיפ לזכירה:</h3>
                    <p id="tip" class="text-md text-green-900 italic whitespace-pre-line"></p>
                </div>
            </div>

            <!-- כפתור שאלה הבאה (מוסתר) -->
            <button id="next-btn"
                    onclick="nextQuestion()"
                    class="w-full mt-4 bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors duration-300 shadow-md hidden focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                השאלה הבאה
            </button>
        </div>

        <!-- מסך סיום -->
        <div id="completion-screen" class="text-center hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">כל הכבוד!</h2>
            <p class="text-xl text-gray-600 mb-6">סיימת את המבחן בהצלחה.</p>
            <button onclick="restartQuiz()"
                    class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                התחל מחדש
            </button>
        </div>
    </div>

    <script>
        // מאגר 15 השאלות הפתוחות
        const quizData = [
          {
            "term": "הקומולונימבוס (Cb)",
            "questions": [
              "א. מהו קומולונימבוס?",
              "ב. מהם המצבים הסינופטיים/ציינו שני מצבים סינופטיים בהם נצפה להתקל בתופעה בארץ?",
              "ג. תאר/י את כל/שלושה הסיכונים התעופתיים הקשורים לתופעה זו."
            ],
            "definition": "א. קומולונימבוס (Cb) הוא ענן סערה ערמתי, הענן המפותח ביותר בטבע. הוא נוצר מאי-יציבות אטמוספרית חזקה וזרימות אנכיות עזות. פסגותיו מגיעות לרום רב (עד הטרופופאוזה, 10 ק\"מ ומעלה), שם הן נתקלות בה ומתפשטות לצורת סדן המורכב מגבישי קרח.\nב. בישראל נצפה ל-Cb במצבי אי-יציבות חזקה, בעיקר: 1. שקע קפריסאי (שקע חזיתי) - במיוחד בזמן מעבר החזית הקרה. 2. אפיק ים סוף פעיל - כאשר אפיק קרקעי משתלב עם אפיק רום ומספק לחות ואי-יציבות.\nג. סיכונים תעופתיים עיקריים: 1. זרמים אנכיים חזקים וגזירות רוח (Downdraft / מיקרוברסט). 2. התקרחות חמורה (בשל מים בקירור יתר). 3. ברד (העלול לגרום נזק מבני). 4. ברקים (העלולים לפגוע במערכות). 5. חתחותים (טורבולנציה) קשים והגבלת ראות חמורה.",
            "explanation": "ה-Cb הוא למעשה 'מנוע' אטמוספרי. הסכנות שהוא מציב הופכות אותו לאויב מס' 1 בתעופה, ויש להימנע מטיסה בתוכו ובסביבתו הקרובה. הוא מכיל את כל סוגי המשקעים (גשם, שלג, גראופל וברד) ופעילות חשמלית ענפה.",
            "tip": "זכרו Cb = 'סכנה ברורה'. זהו ענן הסערה האולטימטיבי עם כל הסכנות בחבילה אחת: קרח, ברד, ברק ורוחות חזקות."
          },
          {
            "term": "אפקט הבריזה",
            "questions": [
              "א. תאר/י את הגורמים להיווצרות בריזה ואת האזורים המושפעים מתופעה זו, ניתן להעזר בשרטוט.",
              "ב. הסביר/י מהו ההבדל בין הבריזה ביום ובין הבריזה בלילה? בהסבר ציין/ני את כיווני הבריזה ביום ובלילה בישראל.",
              "ג. כיצד משפיעה הבריזה על הרוח הצפויה? מתי והאם תורגש הבריזה היומית בשדה דב? בחצרים? בעובדה?"
            ],
            "definition": "א. בריזה היא צירקולציה תרמלית (תא זרימה) מקומית הנוצרת עקב הפרשי טמפרטורה בין הים ליבשה (הנובעים מקיבול חום שונה). היא משפיעה על אזורי החוף ומתפשטת לפנים הארץ.\nב. בריזת יום (ימית): ביום, היבשה מתחממת מהר מהים ונוצר עליה שקע תרמלי (לחץ נמוך). אוויר קר וכבד יותר זורם מהים (לחץ גבוה יחסית) אל היבשה. בישראל: רוח מערבית.\nבריזת לילה (יבשתית): בלילה, היבשה מתקררת מהר מהים ונוצרת עליה רמה תרמית (לחץ גבוה). אוויר זורם מהיבשה הקרה אל הים החם יחסית. בישראל: רוח מזרחית.\nג. הבריזה משפיעה על כיוון ועוצמת הרוח. היא תורגש חזק ובשעות הצהריים-אחר הצהריים בשדה דב (על החוף). היא תורגש גם בחצרים, אך מאוחר יותר אחה\"צ וחלשה יותר. היא כמעט ולא תורגש בעובדה, הרחוקה מדי מהשפעת הים התיכון.",
            "explanation": "בקיץ בישראל, הזרימה הכללית היא צפון-מערבית (מהאפיק הפרסי). בריזת היום (מערבית) 'תומכת' בזרימה זו ומחזקת אותה מאוד משעות הצהריים. בריזת הלילה (מזרחית) 'נלחמת' בזרימה הכללית ולכן היא חלשה יותר.",
            "tip": "יום = יבשה חמה = שקע. הרוח באה 'להצטנן' מהים.\nלילה = יבשה קרה = רמה. הרוח 'בורחת' מהקור ביבשה אל הים."
          },
          {
            "term": "שקע חזיתי",
            "questions": [
              "א. תאר/י בקצרה את מהלך חייו של שקע חזיתי.",
              "ב. אילו עננים נצפה לראות בחזית החמה? מדוע?",
              "ג. אילו עננים נצפה לראות בחזית הקרה? מדוע?"
            ],
            "definition": "א. מהלך חיים: 1. היווצרות: מתחיל כמפגש בין גוש אוויר חם וקר (חזית נייחת). 2. התפתחות: הפרעה (גל) גורמת לאוויר להסתחרר ונוצר שקע עם חזית חמה וחזית קרה. 3. אוקלוזיה (התלכדות): החזית הקרה, שמהירה יותר, 'מדביקה' את החזית החמה. 4. דעיכה: השקע מתמלא, הופך הומוגני ומתפוגג.\nב. חזית חמה: אוויר חם (קל) מטפס במתינות מעל אוויר קר הנסוג. עלייה מתונה ויציבה זו יוצרת אינברסיה ומדכאת ענני סערה. לכן נצפה לעננות שכבתית נרחבת (סטרטוס, אלטוסטרטוס, נימבוסטרטוס) וגשם קל ומתמשך.\nג. חזית קרה: אוויר קר (כבד) חודר במהירות מתחת לאוויר חם ודוחף אותו למעלה בחדות. עלייה מהירה ובלתי יציבה זו יוצרת עננות ערמתית מפותחת, כולל קומולונימבוס (Cb), המלווים בממטרים חזקים, סופות רעמים וברד.",
            "explanation": "השקע הקפריסאי, הגורם העיקרי לגשם חורפי בישראל, הוא דוגמה קלאסית לשקע חזיתי.",
            "tip": "חמה = טיפוס מתון = ענני 'שטיח' (סטרטוס).\nקרה = דחיפה אגרסיבית = ענני 'מגדל' (קומולוס)."
          },
          {
            "term": "זרם סילון",
            "questions": [
              "א. מהו זרם סילון?",
              "ב. תאר/י את השפעתו של זרם הסילון על תעופה.",
              "ג. כיצד משפיע זרם הסילון על מזג האוויר בארץ?"
            ],
            "definition": "א. זרם סילון הוא רצועה צרה של רוחות חזקות מאוד (מעל 75 קשר) ברום הטרופוספרה (גובה 7-15 ק\"מ). הוא נוצר בגבולות בין גושי אוויר עם טמפרטורות שונות (גרדיאנט טמפרטורה חריף) וזורם בצורה גלית (גלי רוסבי).\nב. השפעה על תעופה: 1. זמני טיסות/דלק: טיסה עם כיוון הסילון (ממערב למזרח) מקצרת משמעותית את הטיסה ומפחיתה צריכת דלק. 2. חתחותים (טורבולנציה): בכניסה וביציאה מהסילון, ובאזורי גזירה חזקים בתוכו, עלולים להיווצר חתחותים חזקים (CAT - Clear Air Turbulence).\nג. השפעה על מזג האוויר: מיקום אפיק רום בזרם הסילון יוצר התבדרות ('שאיבה') המאפשרת התפתחות שקעים (כמו שקע קפריסאי) על הקרקע. זרם סילון פולארי גלי מאוד מסיע אוויר קר מהקטבים דרומה לאזורנו בחורף.",
            "explanation": "ישנם שני זרמי סילון עיקריים: סובטרופי (גבוה יותר ופחות גלי) ופולארי (נמוך יותר, מהיר יותר וגלי יותר). הסילון הפולארי הוא המשמעותי יותר למזג האוויר בישראל בחורף.",
            "tip": "סילון = 'אוטוסטרדה' של רוח בגובה רב. לטוס איתו זה מהר, לטוס נגדו זה לאט. כשהוא 'מתפתל' (גלי) מעלינו, הוא יוצר 'בלאגן' (מזג אוויר) למטה."
          },
          {
            "term": "מזג האוויר האופייני בישראל בעונת הקיץ",
            "questions": [
              "א. מהו המצב הסינופטי המאפיין עונה זו?",
              "ב. מהם השינויים הצפויים מיום ליום בארץ?",
              "ג. תאר/י את מזג האוויר (בהתייחס למאפיינים הבאים: טמפ', לחות, עננים, תופעות מז\"א) / תאר/י את מזג האוויר במישור החוף (בהתייחס למאפיינים...)."
            ],
            "definition": "א. מצב סינופטי: המצב יציב ומונוטוני. 1. בקרקע: אפיק פרסי (שלוחה של המונסון ההודי) ממזרח ורמה אזורית ממערב, היוצרים יחד זרימה צפון-מערבית קבועה. 2. ברום: רמה סובטרופית הגורמת להתמוככות (שקיעת אוויר), יציבות מוחלטת ומונעת משקעים.\nב. שינויים יומיים: השינויים קטנים מאוד ותלויים בעיקר בגובה האינברסיה המארינית (הנוצרת מההתמוככות ברום). גובהה קובע את ההבדל בטמפ' ובלחות בין ההר (יבש) לחוף (לח).\nג. מזג אוויר בחוף: חם ולח מאוד (הביל). טמפרטורות מתונות (סביב 30-32 מעלות) אך לחות גבוהה (70-90%). בבקרים עשויה להופיע עננות נמוכה (סטרטוס) שמתפזרת. אין משקעים כלל.",
            "explanation": "השילוב של הרמה ברום (ש'לוחצת' מלמעלה) והאפיק בקרקע (שמזרים אוויר לח מהים) יוצר את 'האינברסיה המארינית'. היא זו ש'כולאת' את הלחות וזיהום האוויר במישור החוף, וגורמת להבדל הדרמטי בין החוף הלח להר היבש (כשהאינברסיה נמוכה).",
            "tip": "קיץ = אפיק פרסי + רמה ברום = 'מכסה סיר' (אינברסיה). חם, לח, יציב ו...משעמם מטאורולוגית."
          },
          {
            "term": "אפיק ים סוף (א\"ס)",
            "questions": [
              "גרסה 1: א. הסבר/י והשווה/י את תהליכי ההיווצרות של שני המצבים הסינופטיים הללו (פעיל ולא פעיל). אילו תנאים תורמים להופעה של אחד או של השני?",
              "גרסה 1: ב. פרט/י את תופעות מזג האוויר השכיחות במקרה שנוצר אפיק ים סוף פעיל?",
              "גרסה 1: ג. פרט/י את תופעות מזג האוויר השכיחות במקרה שנוצר אפיק ים סוף לא פעיל?",
              "(לפעמים השאלות מנוסחות באופן ספציפי יותר, כמו במבחן):",
              "א. תאר/י את מזג האוויר הצפוי עבור אפיק לא פעיל עם ציר מערבי (טמפ', רוח, עננות...).",
              "ב. תאר/י את מזג האוויר הצפוי עבור אפיק לא פעיל עם ציר מזרחי (טמפ', רוח, עננות...).",
              "ג. מה יגרום לאפיקים סוף להיות 'פעיל'?"
            ],
            "definition": "א. הגדרה: אפיק ים סוף (א\"ס) הוא שלוחה של שקע תרמלי מאזור סודן המשתרעת צפונה לאורך ים סוף, ואופייני לעונות המעבר.\nההבדל בין פעיל ללא-פעיל (תשובה ל-1א' ו-2ג'):\n1. א\"ס לא פעיל: זהו מצב קרקעי בלבד, ללא תמיכה ברום (לרוב יש רכס רום שגורם להתמוככות ויציבות).\n2. א\"ס פעיל: זהו שילוב של אפיק ים סוף בקרקע יחד עם אפיק רום מעליו. השילוב הזה יוצר 'שאיבה' חזקה, אי-יציבות ועליית אוויר.\nב. א\"ס פעיל (תופעות): מזג אוויר בלתי יציב. זרימת אוויר דרומית מביאה לחות מהאזורים הטרופיים ברום הבינוני. התוצאה היא התפתחות ענני סערה (Cb), גשמים חזקים (לעיתים שטפונות) וסופות רעמים, בעיקר בדרום הארץ ובמזרחה.\nג. א\"ס לא פעיל (תופעות): מזג האוויר תלוי במיקום הציר:\n* ציר מערבי: האפיק ממערב לנו. גורם לרוחות דרום-מזרחיות חמות ויבשות (שרב), אובך וסופות חול.\n* ציר מזרחי: האפיק ממזרח לנו. גורם לרוחות צפוניות קרירות יחסית ויבשות, אך עם אפשרות לערפילי בוקר ועננות שכבתית במישור החוף.",
            "explanation": "הגורם הקובע הוא הרום. אם יש אפיק ברום, המערכת 'פעילה' וגורמת לגשם. אם יש רכס ברום, המערכת 'לא פעילה' וגורמת ליובש ושרב (או ערפילים).",
            "tip": "א\"ס לא פעיל = רק בקרקע = יובש/שרב.\nא\"ס פעיל = קרקע + רום = 'פתוח לשמיים' = אי-יציבות ושטפונות."
          },
          {
            "term": "חורף בישראל (גרסאות 1+2)",
            "questions": [
              "גרסה 1: א. כיצד נקראת מערכת מזג האוויר הגורמת לעיקר המשקעים בחורף באזורנו? תארו בקצרה את מאפייניה הסינופטיים.",
              "גרסה 1: ב. כיצד נוצרת מערכת זו? בתשובתכם התייחסו למאפיינים ברום ובקרקע...",
              "גרסה 2: ג. תאר/י את מזג האוויר במצב הסינופטי הגשום ביותר מכל אלה שהופיעו בסעיף א."
            ],
            "definition": "א. מערכת המשקעים העיקרית בחורף היא שקע קפריסאי. זהו שקע חזיתי (שקע בקרקע עם חזיתות חמה וקרה) שמרכזו לרוב באזור קפריסין.\nב. היווצרות: השקע נוצר כתוצאה ממפגש גושי אוויר (קר מצפון, חם מהים) וחשוב מכל, הוא נוצר בקדמת אפיק רום. אפיק הרום (שקע בגובה) יוצר התבדרות ('שאיבה') המאפשרת לשקע הקרקעי להיווצר ולהעמיק.\nג. מזג האוויר הגשום (מעבר החזית הקרה): זהו שיא האירוע. מתרחשת חיגת רוח חדה למערבית/צפון-מערבית, ירידה חדה בטמפרטורה, ועלייה חדה בלחות. מתפתחת עננות ערמתית בלתי יציבה, כולל קומולונימבוס (Cb), הגורמים לגשמים חזקים, סופות רעמים וברד.",
            "explanation": "בנוסף לשקע הקפריסאי, ישנם מצבים רכסיים (רמה) בין השקעים, הגורמים למזג אוויר נאה ויציב, אך לעיתים קריר מאוד ועם ערפילים בעמקים.",
            "tip": "חורף גשום = שקע קפריסאי. זכרו את הסדר: חמה (שטיח עננים) -> סקטור חם (טפטוף) -> קרה (ה'בום' הגדול עם Cb)."
          },
          {
            "term": "הסירקולציה הגלובאלית",
            "questions": [
              "א. מהם שלושת תאי הזרימה העולמיים ובאלו קווי רוחב הם קיימים?",
              "ב. השוו בין האקלים בחלק הדרומי של תא הדלי לבין החלק הצפוני שלו.",
              "ג. הסבירו את התפקיד של כוח קוריוליס בהיווצרות תאי הצירקולציה."
            ],
            "definition": "א. שלושת התאים (בכל חצי כדור) הם: \n1. תא הדלי (Hadley Cell): מקו המשווה (0°) עד קו רוחב 30°.\n2. תא פרל (Ferrel Cell): מקו רוחב 30° עד 60°.\n3. תא פולארי (Polar Cell): מקו רוחב 60° עד הקוטב (90°).\nב. תא הדלי: בחלקו הדרומי (סביב קו המשווה) נמצא אזור ההתכנסות הבין-טרופי (ITCZ). זהו אזור לחץ נמוך עם עליית אוויר חם ולח, הגורם לגשמים טרופיים. בחלקו הצפוני (סביב 30°) נמצאת הרמה הסובטרופית. זהו אזור לחץ גבוה עם שקיעת אוויר (התמוככות), הגורם להתייבשות וליצירת 'רצועת המדבריות' העולמית.\nג. כוח קוריוליס: לולא סיבוב כדור הארץ, היה תא אחד גדול מהמשווה לקוטב. כוח קוריוליס (הנובע מסיבוב כדוה\"א) מסיט את האוויר ימינה (בצפון). הוא גורם לאוויר שעולה בקו המשווה וזורם צפונה ברום 'להסתובב' ימינה, להיבלם ולשקוע בקו 30°, ובכך 'שובר' את התא הגדול ויוצר את שלושת התאים.",
            "explanation": "הסירקולציה הגלובלית היא 'מערכת ההפעלה' של האקלים. היא זו שמעבירה עודפי חום מהמשווה (שם יש עודף קרינה) לקטבים (שם יש חוסר קרינה).",
            "tip": "תא הדלי: עולה במשווה (ג'ונגל), יורד ב-30° (מדבר).\nקוריוליס = ה'מסובב' הראשי ששובר תא אחד לשלושה."
          },
          {
            "term": "המונסון ההודי",
            "questions": [
              "א. הסבירו מהו המונסון ההודי.",
              "ב. כיצד משפיע המונסון ההודי על עונת הקיץ בישראל?",
              "ג. מהי המערכת הגלובאלית הנוספת אשר משפיעה על ישראל בקיץ? תארו את השפעתה."
            ],
            "definition": "א. המונסון ההודי הוא שקע תרמלי עונתי עמוק, הנוצר בקיץ עקב התחממות יבשת אסיה. הוא שואב אוויר לח וחם מהאוקיינוס וגורם לגשמי זעף בהודו ודרום מזרח אסיה.\nב. השפעה על ישראל: השקע המונסוני שולח שלוחה מערבה, המכונה 'האפיק הפרסי'. אפיק זה בקרקע, יחד עם הרמה האזורית ממערב, הוא הגורם לזרימה הצפון-מערבית היציבה בישראל בקיץ.\nג. המערכת הנוספת: הרמה הסובטרופית (האזורית). זוהי רמה ברום (לחץ גבוה בגובה) השוקעת מעל אזורנו בקיץ. היא גורמת להתמוככות (שקיעת אוויר), יוצרת יציבות מוחלטת, מונעת משקעים, ויוצרת את האינברסיה המארינית.",
            "explanation": "השילוב של שתי המערכות האלה הוא שקובע את אופי הקיץ הישראלי: האפיק הפרסי (ממזרח) והרמה האזורית (ממערב) 'תופסות' את ישראל ביניהן ויוצרות את הזרימה הצפון-מערבית. הרמה ברום (מלמעלה) דואגת שיהיה יציב וללא גשם.",
            "tip": "מונסון = גשם בהודו = שקע ענק.\nשקע ענק -> שולח 'זרוע' (אפיק פרסי) -> נותן לנו רוח צפון-מערבית בקיץ."
          },
          {
            "term": "שקע שרבי",
            "questions": [
              "א. הסבירו מהו שקע שרבי, באיזה עונה הוא נוצר ומה הם הגורמים התורמים להיווצרותו?",
              "ב. אילו תופעות מסוכנות לטיסה נצפה לפגוש במהלך מעבר השקע?",
              "ג. תארו את מהלך מזג האוויר בחצרים בזמן מעבר השקע השרבי."
            ],
            "definition": "א. שקע שרבי (או שקע צפון אפריקאי) הוא שקע תרמלי חם ויבש הנוצר בעיקר בעונות המעבר (אביב). הוא נוצר עקב הפרשי טמפרטורה חריפים בין מדבר סהרה החם לים התיכון הקריר יחסית, ונע במהירות מזרחה לאורך חופי צפון אפריקה.\nב. סכנות לטיסה: 1. רוחות חזקות (במיוחד בסקטור החם). 2. סופות חול ואבק (אובך) הפוגעים קשות בראות ועלולים לגרום נזק למנועים. 3. 'שבירת שרב': מעבר חד ומהיר של החזית הקרה, המלווה בחיגת רוח חדה ומשבי רוח חזקים.\nג. מהלך בחצרים: 1. בסקטור החם (לפני השקע): רוחות מזרחיות/דרום-מזרחיות חזקות, חם מאוד ויבש (שרב), אובך כבד וסופות חול. 2. 'שבירת השרב' (מעבר החזית הקרה): חיגת רוח פתאומית למערבית/צפון-מערבית, ירידה דרמטית בטמפרטורה, עלייה חדה בלחות, משבי רוח חזקים מאוד, והאובך הכבד הופך ל'אובך לח' (בוץ באוויר) עם ראות גרועה מאוד.",
            "explanation": "השקע השרבי שונה משקע קפריסאי בכך שהוא מגיע מדרום-מערב (צפון אפריקה) והוא חם ויבש בבסיסו, בעוד שקע קפריסאי מגיע מצפון-מערב והוא קר ולח.",
            "tip": "שרבי = סהרה. שקע שמביא איתו את כל החום והאבק מהמדבר. הסכנה העיקרית: אובך ו'שבירה' פתאומית."
          },
          {
            "term": "משקעים",
            "questions": [
              "א. תאר/י בקצרה את תהליך הגידול של טיפונות ענן ליצירת גשם.",
              "ב. הסבר/הסבירי בקצרה כיצד נוצרים ברד ושלג.",
              "ג. מהו הקשר בין תהליך ההיווצרות של ברד ושלג לתופעת ההתקרחות במטוסים?"
            ],
            "definition": "א. יצירת גשם: טיפונות ענן זעירות גדלות בשתי דרכים: 1. התנגשות והתלכדות ('גשם חם'): טיפות גדולות נופלות מהר יותר, מתנגשות בטיפות קטנות ו'בולעות' אותן. 2. תהליך 'גשם קר' (ברגרון): בענן קר (מתחת 0°C), גבישי קרח סופחים אליהם אדי מים מהר יותר מטיפות המים בקירור-יתר שסביבם. גבישי הקרח גדלים על חשבון הטיפות, הופכים כבדים, נופלים ומפשירים בדרכם למטה.\nב. שלג: נוצר בתהליך 'גשם קר', כאשר גבישי הקרח גדלים ונופלים, אך הטמפרטורה בכל שכבת האוויר (מהענן עד הקרקע) נשארת מתחת 0°C, ולכן הם לא מפשירים.\nברד: נוצר בענני סערה (Cb) עם זרמים אנכיים חזקים. גביש קרח נזרק מעלה ומטה בתוך הענן, אוסף עליו שכבות של מים בקירור-יתר שקופאות עליו, עד שהוא כבד מספיק כדי להתגבר על הזרם העולה וליפול.\nג. הקשר להתקרחות: המרכיב המשותף ל'גשם קר', ברד, והתקרחות הוא מים בקירור-יתר (טיפות מים נוזליות בטמפרטורה מתחת 0°C). מטוס שטס דרך ענן המכיל טיפות כאלו משמש כ'גרעין קיפאון' ענק, והטיפות בקירור-יתר קופאות עליו מיד במגע ויוצרות התקרחות.",
            "explanation": "סוגי התקרחות שונים (כפור, קרח כפורי, קרח זגוגי) תלויים בגודל הטיפות ובטמפרטורה.",
            "tip": "המרכיב הסודי לרוב המשקעים וההתקרחות הוא 'מים בקירור-יתר' - טיפות מים מבולבלות שלא יודעות שהן צריכות לקפוא."
          },
          {
            "term": "עונות השנה בכדור הארץ ובארץ ישראל",
            "questions": [
              "א. מהי הסיבה להיווצרותן של עונות השנה בכדור הארץ?",
              "ב. תאר/י בקצרה שתי מערכות סינופטיות הפוקדות את ישראל בעונות המעבר.",
              "ג. פרטו והסבירו את התופעות מסוכנות לטיסה בהן אנו עלולים להיתקל באחת המערכות."
            ],
            "definition": "א. הסיבה לעונות השנה היא נטיית ציר הסיבוב של כדור הארץ ב-23.5 מעלות יחסית למישור המילקה (המישור בו הוא מקיף את השמש). נטייה זו גורמת לשינוי בזווית פגיעת קרני השמש ובאורך היום בחצי הכדור הצפוני והדרומי במהלך השנה.\nב. מערכות בעונות המעבר (אביב/סתיו): 1. שקע שרבי: שקע חם ויבש המגיע מצפון אפריקה. 2. אפיק ים סוף (פעיל או לא פעיל): שלוחת שקע מאזור סודן.\nג. סכנות לטיסה בשקע שרבי: 1. רוחות חזקות. 2. סופות חול ואבק (אובך) הפוגעים קשות בראות ועלולים לגרום נזק למנועים. 3. 'שבירת שרב' פתאומית עם גזירות רוח חזקות.",
            "explanation": "בניגוד לתפיסה נפוצה, עונות השנה *לא* נגרמות בגלל שינוי המרחק מהשמש. למעשה, בחצי הכדור הצפוני, החורף מתרחש כשאנו קרובים יותר לשמש (פריהליון).",
            "tip": "עונות = נטייה (Axis Tilt). לא מרחק! זווית השמש היא שקובעת. \nעונות מעבר = 'בלאגן' סינופטי. בעיקר שרב (אבק) ואפיק ים סוף (יובש או שטפונות)."
          },
          {
            "term": "שקע קפריסאי",
            "questions": [
              "א. תארו את מזג האוויר הצפוי לפני מעבר החזית החמה ולאחריה (טמפ, רוח, עננות...).",
              "ב. תארו את מזג האוויר הצפוי עם מעבר החזית הקרה (טמפ, רוח, עננות...).",
              "ג. מהן הסכנות לטיסה שנצפה לפגוש בבסיס חצרים במהלך מעבר השקע? וברמת דוד?"
            ],
            "definition": "א. לפני חזית חמה: רוחות דרום-מזרחיות (יבשות וקרות מהיבשה), טמפ' נמוכות, שמיים מתכסים בהדרגה בעננות גבוהה ובינונית (צירוס, אלטוסטרטוס).\nאחרי חזית חמה (בסקטור החם): רוחות דרומיות/דרום-מערביות (חמות ולחות מהים), טמפ' עולה, לחות עולה. בדרום (חצרים) הרוחות הדרומיות עלולות לגרום לאובך וסופות חול.\nב. מעבר חזית קרה: זהו שיא האירוע. חיגת רוח חדה למערבית/צפון-מערבית, ירידה חדה בטמפרטורה, משבי רוח חזקים, עלייה חדה בלחות, והתפתחות עננות ערמתית (Cb) עם גשמים חזקים, סופות רעמים וברד.\nג. סכנות לטיסה: \n* בחצרים (דרום): 1. בסקטור החם: רוחות דרומיות חזקות ואובך/סופות חול. 2. בחזית הקרה: כל סכנות ה-Cb (ברד, ברקים, התקרחות, גזירת רוח).\n* ברמת דוד (עמק): 1. בחזית הקרה: כל סכנות ה-Cb. 2. לאחר מעבר השקע, כשרמה נבנית: סכנה של ערפל קרינה עקב הקרקע הרטובה והאוויר הקר ששוקע בעמק בלילה.",
            "explanation": "שקע קפריסאי הוא השקע החזיתי הקלאסי של החורף הישראלי, והוא נע ממערב למזרח, לכן הגשם מגיע קודם לצפון (רמת דוד) ורק אז למרכז ודרום (חצרים).",
            "tip": "קפריסאי = חורף. זכרו את הסדר: חמה (שטיח עננים) -> סקטור חם (טפטוף/אבק) -> קרה (ה'בום' הגדול עם Cb)."
          },
          {
            "term": "מצבים רכסיים",
            "questions": [
              "א. הסבירו מהי רמה/רכס וכיצד יזרום בה האוויר.",
              "ב. ציינו שתי מערכות של רכס/רמה האופייניות לישראל.",
              "ג. בהתייחס לשתי המערכות שציינתם בסעיף א'- מה תהיה הרוח בישראל בכל אחת אחת מהן? מה יהיו מאפייני האוויר במצב זה? (מבחינת לחות, טמפ')."
            ],
            "definition": "א. רמה/רכס הוא אזור שבו לחץ האוויר גבוה ביחס לסביבתו. אוויר ברום שוקע (מתמוכך), מתחמם ומתייבש. בקרקע, האוויר זורם ממרכז הרמה החוצה (מתבדר) בתנועה אנטי-ציקלונית (עם כיוון השעון בחצי הכדור הצפוני).\nב. מערכות רכס לישראל: 1. רמה אזורית (שלוחה של הרמה הסובטרופית) - מגיעה בין שקעים בחורף. 2. רמה סיבירית - שלוחה של רמה קרה מאוד ממרכז אסיה, מגיעה בחורף.\nג. רמה אזורית: גורמת למזג אוויר נאה ויציב. רוחות צפוניות-מערביות קלות. האוויר יבש וקריר, אך מאפשר התקררות קרינתית חזקה בלילה ועלול לגרום לערפל קרינה בעמקים.\nרמה סיבירית: גורמת להתקררות קיצונית. רוחות צפוניות-מזרחיות (מזרחיות), יבשות וקרות מאוד. מזג אוויר בהיר, יציב וקר מאוד (קרה חמורה).",
            "explanation": "הרמה האזורית היא גם המערכת הדומיננטית ברום בקיץ, שם היא גורמת לאינברסיה המארינית. רכס הוא 'אח של' רמה, כמו שאפיק הוא 'אח של' שקע.",
            "tip": "רמה = 'רם' (גבוה). לחץ גבוה. אוויר יורד מלמעלה (מתמוכך), מתחמם ומתייבש -> מזג אוויר יציב ובהיר."
          },
          {
            "term": "ערפל קרינה וערפל הרים",
            "questions": [
              "א. הסבר/י והשווה/י את תהליכי ההיווצרות של שני סוגי הערפל. באילו אזורים בארץ נצפה לראות כל סוג ערפל?",
              "ב. ציין/ני שני תנאים החייבים להתקיים להיווצרות כל אחד מסוגי הערפל. הסבר/י מדוע תנאים אלו הכרחיים.",
              "ג. ישנה אמרה הגורסת כי לא ניתן לקבל ערפל וסופת רעמים בו זמנית באותו המקום. תן/ני דוגמא לסוג ערפל עבורו אימרה זו נכונה, ודוגמא לסוג ערפל עבורו האימרה אינה נכונה. הסבר/י את תשובתך."
            ],
            "definition": "א. ערפל קרינה: נוצר בלילות בהירים, קרים וללא רוח בתנאי יציבות. הקרקע פולטת קרינה ומתקררת מאוד, ומקררת את שכבת האוויר שמעליה (בהולכה) אל מתחת לנקודת הטל. זהו ערפל 'מקומי'. נפוץ בעמקים ומישורים פנימיים (למשל עמק יזרעאל, צפון הנגב).\nערפל הרים (אורוגרפי): זהו ענן (לרוב סטרטוס) שבסיסו נמוך מפסגת ההר. הוא נוצר מתהליך אדיאבטי - אוויר לח נאלץ לעלות במעלה ההר (אילוץ אורוגרפי), מתקרר, ומגיע לרוויה. נפוץ בפסגות ההרים (הרי יהודה, גליל).\nב. ערפל קרינה: 1. לילה בהיר (לקרינה לברוח מהקרקע). 2. רוח חלשה (כדי שהאוויר הקר יישאר צמוד לקרקע ולא יתערבב עם אוויר חם מעל).\nערפל הרים: 1. אוויר לח. 2. רוח בכיוון ההר (כדי 'לדחוף' את האוויר במעלה).\nג. האמרה נכונה לערפל קרינה: סופת רעמים (Cb) דורשת אי-יציבות קיצונית, בעוד ערפל קרינה דורש יציבות מוחלטת (אינברסיה קרקעית). אלו תנאים הפוכים.\nהאמרה אינה נכונה לערפל הרים: אם ענן סערה (Cb) מפותח 'עוטף' פסגת הר, אדם על הפסגה יחווה ערפל כבד (הוא בתוך הענן) ובו זמנית סופת רעמים.",
            "explanation": "ההבדל המהותי: ערפל קרינה נוצר מהתקררות במקום (הולכה מהקרקע), ערפל הרים נוצר מתנועה (קירור אדיאבטי בעלייה).",
            "tip": "קרינה = קור מהקרקע. הרים = ענן ש'נתקע' בהר."
          }
        ];


        let currentQuestionIndex = 0;
        let shuffledQuizData = [];
        let isEvaluating = false;

        // רכיבי DOM
        const quizContainer = document.getElementById('quiz-container');
        const completionScreen = document.getElementById('completion-screen');
        const questionCounter = document.getElementById('question-counter');
        const termEl = document.getElementById('term');
        const subQuestionsEl = document.getElementById('sub-questions');
        const userAnswerEl = document.getElementById('user-answer');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedbackContainer = document.getElementById('feedback-container');
        const loader = document.getElementById('loader');
        const feedbackEl = document.getElementById('feedback');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const correctAnswerContainer = document.getElementById('correct-answer-container');
        const correctAnswerEl = document.getElementById('correct-answer');
        const definitionEl = document.getElementById('definition');
        const explanationEl = document.getElementById('explanation');
        const tipEl = document.getElementById('tip');
        const questionIndexContainer = document.getElementById('question-index');
        const standaloneNav = document.getElementById('standalone-nav');
        const resetActions = document.getElementById('reset-actions');
        const retryBtn = document.getElementById('retry-btn');
        const resetQuizBtn = document.getElementById('reset-quiz-btn');

        const STORAGE_KEY = 'open_quiz_state_v1';
        let shuffledOrder = [];
        let questionStates = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (window.self === window.top) {
                standaloneNav.classList.remove('hidden');
            }
            startQuiz();
        });

        function createEmptyState() {
            return { answer: '', feedback: '', showAnswer: false, status: 'unanswered' };
        }

        function loadSavedState() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) {
                    return null;
                }

                const parsed = JSON.parse(stored);
                if (!Array.isArray(parsed.order) || parsed.order.length !== quizData.length) {
                    localStorage.removeItem(STORAGE_KEY);
                    return null;
                }

                if (!Array.isArray(parsed.questionStates) || parsed.questionStates.length !== quizData.length) {
                    localStorage.removeItem(STORAGE_KEY);
                    return null;
                }

                if (!parsed.order.every(idx => Number.isInteger(idx) && idx >= 0 && idx < quizData.length)) {
                    localStorage.removeItem(STORAGE_KEY);
                    return null;
                }

                const sanitizedStates = parsed.questionStates.map(state => ({
                    answer: typeof state?.answer === 'string' ? state.answer : '',
                    feedback: typeof state?.feedback === 'string' ? state.feedback : '',
                    showAnswer: Boolean(state?.showAnswer),
                    status: state?.status === 'done' ? 'done' : 'unanswered'
                }));

                const savedIndex = Number.isInteger(parsed.currentQuestionIndex) ? parsed.currentQuestionIndex : 0;

                return {
                    order: parsed.order.slice(),
                    questionStates: sanitizedStates,
                    currentQuestionIndex: Math.min(Math.max(savedIndex, 0), quizData.length - 1),
                    completed: Boolean(parsed.completed)
                };
            } catch (error) {
                console.warn('Failed to load saved quiz state', error);
                return null;
            }
        }

        function saveState(extra = {}) {
            try {
                const payload = {
                    order: shuffledOrder,
                    questionStates,
                    currentQuestionIndex,
                    completed: extra.completed !== undefined ? extra.completed : !completionScreen.classList.contains('hidden')
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
            } catch (error) {
                console.warn('Failed to save quiz state', error);
            }
        }

        function clearSavedState() {
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (error) {
                console.warn('Failed to clear quiz state', error);
            }
        }

        function renderQuestionIndex() {
            questionIndexContainer.innerHTML = '';
            shuffledQuizData.forEach((_, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = index + 1;
                button.className = 'question-index-btn';
                button.addEventListener('click', () => goToQuestion(index));
                questionIndexContainer.appendChild(button);
            });
        }

        function updateQuestionIndex() {
            const buttons = questionIndexContainer.querySelectorAll('button');
            buttons.forEach((btn, idx) => {
                btn.classList.remove('is-active', 'is-in-progress', 'is-answered');
                if (idx === currentQuestionIndex) {
                    btn.classList.add('is-active');
                }
                const state = questionStates[idx];
                if (!state) {
                    return;
                }
                if (state.status === 'done') {
                    btn.classList.add('is-answered');
                } else if (state.status === 'in-progress') {
                    btn.classList.add('is-in-progress');
                }
            });
        }

        function goToQuestion(index) {
            if (isEvaluating) {
                return;
            }
            currentQuestionIndex = index;
            loadQuestion();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz(reset = false) {
            let savedState = null;
            if (!reset) {
                savedState = loadSavedState();
            }

            if (savedState) {
                shuffledOrder = savedState.order.slice();
                shuffledQuizData = shuffledOrder.map(idx => quizData[idx]);
                questionStates = savedState.questionStates;
                currentQuestionIndex = savedState.currentQuestionIndex;
                isEvaluating = false;
                quizContainer.classList.toggle('hidden', savedState.completed);
                completionScreen.classList.toggle('hidden', !savedState.completed);
                renderQuestionIndex();
                if (savedState.completed) {
                    updateQuestionIndex();
                    saveState({ completed: true });
                } else {
                    loadQuestion();
                }
                return;
            }

            shuffledOrder = shuffleArray(Array.from({ length: quizData.length }, (_, idx) => idx));
            shuffledQuizData = shuffledOrder.map(idx => quizData[idx]);
            questionStates = shuffledQuizData.map(() => createEmptyState());
            currentQuestionIndex = 0;
            isEvaluating = false;
            quizContainer.classList.remove('hidden');
            completionScreen.classList.add('hidden');
            renderQuestionIndex();
            loadQuestion();
            saveState();
        }

        function loadQuestion() {
            updateQuestionIndex();

            if (currentQuestionIndex >= shuffledQuizData.length) {
                quizContainer.classList.add('hidden');
                completionScreen.classList.remove('hidden');
                saveState({ completed: true });
                return;
            }

            const question = shuffledQuizData[currentQuestionIndex];
            const state = questionStates[currentQuestionIndex];

            termEl.textContent = question.term;
            questionCounter.textContent = `שאלה ${currentQuestionIndex + 1} / ${shuffledQuizData.length}`;

            subQuestionsEl.innerHTML = '';
            question.questions.forEach(q => {
                const p = document.createElement('p');
                p.textContent = q;
                subQuestionsEl.appendChild(p);
            });

            userAnswerEl.value = state.answer || '';
            loader.classList.add('hidden');

            if (state.status === 'done') {
                userAnswerEl.disabled = true;
                feedbackContainer.classList.remove('hidden');
                feedbackEl.textContent = state.feedback;
                submitBtn.classList.add('hidden');
                submitBtn.disabled = false;
                nextBtn.classList.remove('hidden');
                nextBtn.textContent = currentQuestionIndex === shuffledQuizData.length - 1 ? 'סיום הבוחן' : 'השאלה הבאה';
                correctAnswerContainer.classList.remove('hidden');
                retryBtn.classList.remove('hidden');
                retryBtn.disabled = false;
                if (state.showAnswer) {
                    correctAnswerEl.classList.remove('hidden');
                    showAnswerBtn.textContent = 'הסתר תשובה מלאה';
                    definitionEl.textContent = question.definition;
                    explanationEl.textContent = question.explanation;
                    tipEl.textContent = question.tip;
                } else {
                    correctAnswerEl.classList.add('hidden');
                    showAnswerBtn.textContent = 'הצג תשובה מלאה';
                }
            } else {
                userAnswerEl.disabled = false;
                feedbackContainer.classList.add('hidden');
                feedbackEl.textContent = '';
                submitBtn.classList.remove('hidden');
                submitBtn.disabled = false;
                nextBtn.classList.add('hidden');
                correctAnswerContainer.classList.add('hidden');
                correctAnswerEl.classList.add('hidden');
                showAnswerBtn.textContent = 'הצג תשובה מלאה';
                retryBtn.classList.add('hidden');
                retryBtn.disabled = true;
                if (state.status === 'in-progress') {
                    feedbackContainer.classList.remove('hidden');
                    feedbackEl.textContent = 'Gemini חושב על המשוב שלך...';
                }
            }

            if (questionStates.some(s => s.status === 'done')) {
                resetActions.classList.remove('hidden');
                resetQuizBtn.disabled = false;
            } else {
                resetActions.classList.add('hidden');
                resetQuizBtn.disabled = true;
            }

            saveState();
        }

        function submitAnswer() {
            if (isEvaluating) {
                return;
            }

            const userAnswer = userAnswerEl.value;
            const correctDefinition = shuffledQuizData[currentQuestionIndex].definition;

            if (userAnswer.trim() === '') {
                feedbackEl.textContent = 'אנא הזן/י תשובה.';
                feedbackContainer.classList.remove('hidden');
                feedbackEl.classList.remove('hidden');
                loader.classList.add('hidden');
                return;
            }

            const state = questionStates[currentQuestionIndex];
            state.answer = userAnswer;
            state.feedback = '';
            state.showAnswer = false;
            state.status = 'in-progress';

            isEvaluating = true;
            updateQuestionIndex();
            saveState();

            feedbackContainer.classList.remove('hidden');
            feedbackEl.textContent = 'Gemini חושב על המשוב שלך...';
            loader.classList.remove('hidden');
            submitBtn.disabled = true;
            userAnswerEl.disabled = true;
            resetQuizBtn.disabled = true;
            retryBtn.disabled = true;
            correctAnswerContainer.classList.add('hidden');
            correctAnswerEl.classList.add('hidden');
            showAnswerBtn.textContent = 'הצג תשובה מלאה';

            checkWithGemini(userAnswer, correctDefinition);
        }

        function showAnswer() {
            const state = questionStates[currentQuestionIndex];
            const isHidden = correctAnswerEl.classList.toggle('hidden');
            state.showAnswer = !isHidden;
            showAnswerBtn.textContent = isHidden ? 'הצג תשובה מלאה' : 'הסתר תשובה מלאה';

            if (!isHidden) {
                const question = shuffledQuizData[currentQuestionIndex];
                definitionEl.textContent = question.definition;
                explanationEl.textContent = question.explanation;
                tipEl.textContent = question.tip;
            }

            saveState();
        }

        function retryQuestion() {
            if (isEvaluating) {
                return;
            }

            const state = questionStates[currentQuestionIndex];
            state.answer = '';
            state.feedback = '';
            state.showAnswer = false;
            state.status = 'unanswered';

            userAnswerEl.value = '';
            userAnswerEl.disabled = false;
            submitBtn.classList.remove('hidden');
            submitBtn.disabled = false;
            nextBtn.classList.add('hidden');
            feedbackContainer.classList.add('hidden');
            feedbackEl.textContent = '';
            loader.classList.add('hidden');
            correctAnswerContainer.classList.add('hidden');
            correctAnswerEl.classList.add('hidden');
            showAnswerBtn.textContent = 'הצג תשובה מלאה';
            retryBtn.classList.add('hidden');
            retryBtn.disabled = true;

            if (questionStates.some(s => s.status === 'done')) {
                resetActions.classList.remove('hidden');
                resetQuizBtn.disabled = false;
            } else {
                resetActions.classList.add('hidden');
                resetQuizBtn.disabled = true;
            }

            updateQuestionIndex();
            saveState();
            userAnswerEl.focus();
        }

        function nextQuestion() {
            if (isEvaluating) {
                return;
            }
            currentQuestionIndex++;
            loadQuestion();
        }

        function shuffleQuestions() {
            restartQuiz();
        }

        function restartQuiz() {
            if (isEvaluating) {
                return;
            }
            clearSavedState();
            shuffledOrder = [];
            startQuiz(true);
        }

        // --- לוגיקת Gemini API ---

        const apiKey = "AIzaSyAnK5NXA_R_dMSKLYkQL_ka5mywJg5Hkk4";
        const geminiModel = 'gemini-2.5-flash-lite-preview-09-2025';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`;
        // פונקציה לטיפול ב-Backoff
        async function handleRetry(url, options, n = 5, delay = 1200) {
            try {
                return await fetch(url, options);
            } catch (err) {
                if (n === 1) throw err;
                await new Promise(resolve => setTimeout(resolve, delay));
                return await handleRetry(url, options, n - 1, delay * 2);
            }
        }

        async function sendGeminiRequest({ systemPrompt, userPrompt }) {
            const payload = {
                contents: [{ role: 'user', parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    role: 'system',
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    maxOutputTokens: 8000,
                    temperature: 0.35,
                    topP: 0.9,
                    topK: 32
                }
            };

            // Explicitly ensure no safety settings are sent to avoid INVALID_ARGUMENT errors.
            delete payload.safetySettings;

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const response = await handleRetry(apiUrl, options);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error?.message || response.statusText}`);
            }

            const result = await response.json();
            console.log('Gemini API Response:', result);

            const candidate = result.candidates?.[0];
            const parts = candidate?.content?.parts || [];
            const text = parts
                .map(part => part?.text || '')
                .join('\n')
                .trim();

            const finishReason = candidate?.finishReason;
            const promptBlock = result.promptFeedback?.blockReason;
            const blockReason = finishReason && finishReason !== 'STOP' ? finishReason : promptBlock || null;

            return { text, blockReason };
        }

        async function checkWithGemini(userAnswer, correctDefinition) {
            const state = questionStates[currentQuestionIndex];
            const systemPrompt = "אתה מורה פרטי למטאורולוגיה. השווה בקצרה בין התשובה שלי לבין החומר לימוד. כתוב רק בעברית, עד חמישה משפטים, התמקד בדיוק מה לשפר ומה חסר תדע לומר שזה לא נכון אבל גם להחמיא על הדברים הנכונים. יכול להכניס בדיחה במקרה שזה מאוד נכון או מאוד גרוע. אל תכלול דיון מדיניות או פירוט תהליך פנימי.";
            const basePrompt = `
                שאלה: "${shuffledQuizData[currentQuestionIndex].term}"
                מהחומר: "${correctDefinition}"
                ---
                תשובה שלי: "${userAnswer}"
                ---
                משוב (בעברית עד חמישה משפטים):
            `;

            let feedbackText = '';
            let lastBlockReason = null;
            let lastError = null;

            try {
                const { text, blockReason } = await sendGeminiRequest({
                    systemPrompt,
                    userPrompt: basePrompt
                });

                if (text) {
                    feedbackText = text;
                } else if (blockReason) {
                    lastBlockReason = blockReason;
                } else {
                    lastError = new Error('No text returned from Gemini response.');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                lastError = error;
            }

            loader.classList.add('hidden');

            if (feedbackText) {
                state.feedback = feedbackText.trim();
            } else if (lastBlockReason) {
                state.feedback = `המודל חסם את המשוב (${lastBlockReason}). להמשך תרגול קרא/י את התשובה לדוגמה המצורפת.`;
            } else {
                state.feedback = "לא הצלחתי לקבל משוב מג'מיני כרגע. השתמש/י בתשובה לדוגמה כדי לבדוק את עצמך.";
            }

            if (!feedbackText) {
                state.feedback += `\n\nתשובה לדוגמה: ${correctDefinition}`;
            }

            state.status = 'done';
            isEvaluating = false;
            feedbackContainer.classList.remove('hidden');
            submitBtn.disabled = false;
            userAnswerEl.disabled = true;
            updateQuestionIndex();
            loadQuestion();
        }

    </script>
</body>

</html>











