<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מבחן שאלות פתוחות במטאורולוגיה</title>
    <!-- טעינת Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- טעינת גופן Rubik (מתאים יותר לעברית מהדוגמה) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* הגדרת גופן ברירת מחדל */
        body {
            font-family: 'Rubik', sans-serif;
        }

        .question-index-wrapper {
            background-color: #f1f5f9;
            border: 1px solid #cbd5f5;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .question-index-wrapper h2 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.75rem;
        }

        .question-index-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            max-height: 10rem;
            overflow-y: auto;
            padding: 0.25rem;
        }

        .question-index-btn {
            width: 2.75rem;
            height: 2.75rem;
            border-radius: 9999px;
            border: 1px solid #cbd5f5;
            background-color: #f8fafc;
            color: #0f172a;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .question-index-btn:hover {
            background-color: #e2e8f0;
        }

        .question-index-btn.is-active {
            background-color: #1d4ed8;
            border-color: #1e3a8a;
            color: #ffffff;
            box-shadow: 0 10px 18px -10px rgba(29, 78, 216, 0.6);
        }

        .question-index-btn.is-in-progress {
            background-color: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .question-index-btn.is-answered {
            background-color: #bae6fd;
            border-color: #0284c7;
            color: #0c4a6e;
        }

        #standalone-nav {
            margin-bottom: 1rem;
        }

        #standalone-nav a {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #0f172a;
            color: #ffffff;
            padding: 0.65rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }

        #standalone-nav a:hover {
            background-color: #1e293b;
        }

        /* סגנון לספינר טעינה */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* סגנון לתשובה המלאה כדי לשמור על מעברי שורה */
        .whitespace-pre-line {
            white-space: pre-line;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-4xl mx-auto">
        
        <!-- כותרת ומונה שאלות -->
        <div class="flex justify-between items-center mb-6 pb-4 border-b">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">מבחן שאלות פתוחות במטאורולוגיה</h1>
            <div id="question-counter" class="text-lg font-semibold text-gray-600 bg-gray-100 px-3 py-1 rounded-full"></div>
        </div>

        <div id="standalone-nav" class="hidden">
            <a href="index.html" aria-label="חזרה לתפריט הראשי">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
                חזרה לתפריט הראשי
            </a>
        </div>

        <div class="question-index-wrapper" aria-label="ניווט מהיר בין השאלות">
            <h2>ניווט מהיר בין השאלות</h2>
            <div id="question-index" class="question-index-container" role="navigation"></div>
        </div>

        <!-- אזור השאלה -->
        <div id="quiz-container">
            <h2 id="term" class="text-3xl font-bold text-gray-900 mb-4"></h2>
            <p class="text-md font-semibold text-blue-700 mb-5">ענה/י על כל סעיפי השאלה:</p>
            <div id="sub-questions" class="text-lg text-gray-800 mb-5 space-y-2 rtl"></div>


            <!-- שדה תשובה -->
            <textarea id="user-answer"
                      class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                      placeholder="הקלד/י את תשובתך המלאה (לכל הסעיפים) כאן..."></textarea>

            <!-- כפתור הגשה -->
            <button id="submit-btn"
                    onclick="submitAnswer()"
                    class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                בדוק את תשובתי (עם Gemini)
            </button>

            <!-- אזור משוב וטעינה -->
            <div id="feedback-container" class="mt-4 min-h-[50px] p-3 bg-gray-50 rounded-lg hidden flex items-center justify-center">
                <div id="loader" class="loader hidden"></div>
                <p id="feedback" class="text-md font-medium text-gray-700"></p>
            </div>

            <!-- אזור תשובה נכונה (מוסתר) -->
            <div id="correct-answer-container" class="mt-6 hidden border-t pt-4">
                <button id="show-answer-btn"
                        onclick="showAnswer()"
                        class="text-sm text-blue-600 hover:underline mb-3 font-medium">
                    הצג/הסתר תשובה מלאה
                </button>
                
                <div id="correct-answer" class="hidden bg-green-50 border border-green-200 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-green-800">תשובת מודל (מבוססת חומר הקורס):</h3>
                    <p id="definition" class="text-md text-green-900 mb-3 whitespace-pre-line"></p>
                    
                    <h3 class="text-lg font-bold text-green-800">הסבר והרחבה:</h3>
                    <p id="explanation" class="text-md text-green-900 mb-3 whitespace-pre-line"></p>
                    
                    <h3 class="text-lg font-bold text-green-800">טיפ לזכירה:</h3>
                    <p id="tip" class="text-md text-green-900 italic whitespace-pre-line"></p>
                </div>
            </div>

            <!-- כפתור שאלה הבאה (מוסתר) -->
            <button id="next-btn"
                    onclick="nextQuestion()"
                    class="w-full mt-4 bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors duration-300 shadow-md hidden focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                השאלה הבאה
            </button>
        </div>

        <!-- מסך סיום -->
        <div id="completion-screen" class="text-center hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">כל הכבוד!</h2>
            <p class="text-xl text-gray-600 mb-6">סיימת את המבחן בהצלחה.</p>
            <button onclick="restartQuiz()"
                    class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                התחל מחדש
            </button>
        </div>
    </div>

    <script>
        // מאגר 15 השאלות הפתוחות
        const quizData = [
            {
                term: "הקומולונימבוס (Cb)",
                questions: [
                    "א. מהו קומולונימבוס?",
                    "ב. מהם המצבים הסינופטיים/ציינו שני מצבים סינופטיים בהם נצפה להתקל בתופעה בארץ?",
                    "ג. תאר/י את כל/שלושה הסיכונים התעופתיים הקשורים לתופעה זו."
                ],
                definition: "א. קומולונימבוס (Cb) הוא ענן סערה ערמתי ומפותח מאוד. פסגותיו מגיעות לגובה רב (עד הטרופופאוזה, 10 ק\"מ ומעלה) ומתפשטות בצורת סדן המורכב מגבישי קרח.\nב. בישראל נצפה ל-Cb במצבי אי-יציבות חזקה, בעיקר: 1. שקע קפריסאי (שקע חזיתי) - במיוחד בזמן מעבר החזית הקרה. 2. אפיק ים סוף פעיל - כאשר יש זרימת אוויר לח ובלתי יציב מהדרום בקרקע יחד עם אפיק רום.\nג. סיכונים תעופתיים עיקריים: 1. גזירות רוח חזקות וזרמים אנכיים (עולים ויורדים - downdraft/מיקרוברסט). 2. התקרחות חמורה (מים בקירור יתר). 3. ברד העלול לגרום נזק מבני. 4. ברקים. 5. הגבלת ראות חמורה וחתחותים (טורבולנציה) קשים.",
                explanation: "ה-Cb הוא למעשה 'מנוע' אטמוספרי. הוא נוצר מאי-יציבות קיצונית, כאשר אוויר חם ולח עולה במהירות. הסכנות שהוא מציב הופכות אותו לאויב מס' 1 בתעופה, ויש להימנע מטיסה בתוכו ובסביבתו הקרובה.",
                tip: "זכרו Cb = 'סכנה ברורה'. זהו ענן הסערה האולטימטיבי עם כל הסכנות בחבילה אחת: קרח, ברד, ברק ורוחות חזקות."
            },
            {
                term: "אפקט הבריזה",
                questions: [
                    "א. תאר/י את הגורמים להיווצרות בריזה ואת האזורים המושפעים מתופעה זו, ניתן להעזר בשרטוט.",
                    "ב. הסביר/י מהו ההבדל בין הבריזה ביום ובין הבריזה בלילה? בהסבר ציין/ני את כיווני הבריזה ביום ובלילה בישראל.",
                    "ג. כיצד משפיעה הבריזה על הרוח הצפויה? מתי והאם תורגש הבריזה היומית בשדה דב? בחצרים? בעובדה?"
                ],
                definition: "א. בריזה היא תא צירקולציה מקומי הנוצר עקב הפרשי טמפרטורה בין הים ליבשה. היא משפיעה על אזורי החוף ופנים הארץ הסמוכים (עד עשרות ק\"מ מהחוף).\nב. בריזת יום (ימית): ביום, היבשה מתחממת מהר מהים, נוצר שקע תרמלי (לחץ נמוך) על היבשה. אוויר קר וכבד יותר זורם מהים (רמה) אל היבשה. בישראל: רוח מערבית.\nבריזת לילה (יבשתית): בלילה, היבשה מתקררת מהר מהים, נוצרת רמה תרמית (לחץ גבוה) על היבשה. אוויר זורם מהיבשה הקרה אל הים החם יחסית. בישראל: רוח מזרחית.\nג. הבריזה משנה את כיוון ועוצמת הרוח. היא תורגש חזק בשדה דב (על קו החוף). היא תורגש גם בחצרים (פנים הארץ) בשעות אחה\"צ, אך מאוחר יותר וחלשה יותר. היא כמעט ולא תורגש בעובדה, הרחוקה מדי מהים התיכון.",
                explanation: "בקיץ בישראל, הזרימה הכללית היא צפון-מערבית. בריזת היום (מערבית) 'תומכת' בזרימה זו ומחזקת אותה מאוד משעות הצהריים. בריזת הלילה (מזרחית) 'נלחמת' בזרימה הכללית ולכן היא חלשה יותר.",
                tip: "יום = יבשה חמה = שקע. הרוח באה 'להצטנן' מהים.\nלילה = יבשה קרה = רמה. הרוח 'בורחת' מהקור ביבשה אל הים."
            },
            {
                term: "שקע חזיתי",
                questions: [
                    "א. תאר/י בקצרה את מהלך חייו של שקע חזיתי.",
                    "ב. אילו עננים נצפה לראות בחזית החמה? מדוע?",
                    "ג. אילו עננים נצפה לראות בחזית הקרה? מדוע?"
                ],
                definition: "א. שקע חזיתי נוצר ממפגש בין גוש אוויר קר לגוש אוויר חם. גושי האוויר מסתחררים (בגלל כוח קוריוליס), האוויר החם (הקל) עולה מעל האוויר הקר (הכבד), והלחץ במרכז יורד. המערכת נעה, ובשלב מסוים החזית הקרה (המהירה) 'מדביקה' את החזית החמה ונוצרת 'אוקלוזיה', שזהו שלב הפירוק של השקע.\nב. חזית חמה: אוויר חם מטפס במתינות ובאיטיות מעל אוויר קר. עלייה מתונה זו יוצרת עננות שכבתית נרחבת, בסדר קבוע: צירוס (גבוה ודק), צירוסטרטוס, אלטוסטרטוס, ולבסוף נימבוסטרטוס (ענן גשם שכבתי).\nג. חזית קרה: אוויר קר וחזק חודר מתחת לאוויר חם ודוחף אותו למעלה במהירות ובאגרסיביות. עלייה מהירה זו יוצרת עננות ערמתית מפותחת, כולל קומולוס וקומולונימבוס (Cb), המלווים בגשמים חזקים, סופות רעמים וברד.",
                explanation: "השקע הקפריסאי, הגורם העיקרי לגשם חורפי בישראל, הוא דוגמה קלאסית לשקע חזיתי.",
                tip: "חמה = טיפוס מתון = ענני 'שטיח' (סטרטוס).\nקרה = דחיפה אגרסיבית = ענני 'מגדל' (קומולוס)."
            },
            {
                term: "זרם סילון",
                questions: [
                    "א. מהו זרם סילון?",
                    "ב. תאר/י את השפעתו של זרם הסילון על תעופה.",
                    "ג. כיצד משפיע זרם הסילון על מזג האוויר בארץ?"
                ],
                definition: "א. זרם סילון הוא רצועה צרה של רוחות חזקות מאוד (מעל 75 קשר) בגבהי הטיסה (ברום הטרופוספרה, גובה 7-15 ק\"מ). הוא נוצר בגבולות בין גושי אוויר עם טמפרטורות שונות (גרדיאנט טמפרטורה חריף).\nב. השפעה על תעופה: 1. קיצור/הארכת זמן טיסה: טיסה עם כיוון הסילון (ממערב למזרח) מקצרת משמעותית את הטיסה. 2. צריכת דלק: בהתאם לקיצור/הארכת הטיסה. 3. חתחותים (טורבולנציה): בכניסה וביציאה מהסילון, ובאזורי גזירה חזקים בתוכו, עלולים להיווצר חתחותים חזקים (CAT - Clear Air Turbulence).\nג. השפעה על מזג האוויר: זרם הסילון (הפולארי) משפיע על התפתחות מערכות מזג אוויר. מיקום אפיק רום בזרם הסילון מעל אזורנו 'שואב' אוויר מהקרקע ומאפשר התפתחות שקעים (כמו שקע קפריסאי). זרם סילון גלי מאוד מסיע אוויר קר מהקטבים דרומה (גורם לקור קיצוני) ואוויר חם צפונה.",
                explanation: "ישנם שני זרמי סילון עיקריים: סובטרופי ופולארי. הסילון הפולארי הוא המשמעותי יותר למזג האוויר בישראל בחורף, והוא גלי יותר.",
                tip: "סילון = 'אוטוסטרדה' של רוח בגובה רב. לטוס איתו זה מהר, לטוס נגדו זה לאט. כשהוא 'מתפתל' (גלי) מעלינו, הוא יוצר 'בלאגן' (מזג אוויר) למטה."
            },
            {
                term: "מזג האוויר האופייני בישראל בעונת הקיץ",
                questions: [
                    "א. מהו המצב הסינופטי המאפיין עונה זו?",
                    "ב. מהם השינויים הצפויים מיום ליום בארץ?",
                    "ג. תאר/י את מזג האוויר (בהתייחס למאפיינים הבאים: טמפ', לחות, עננים, תופעות מז\"א) / תאר/י את מזג האוויר במישור החוף (בהתייחס למאפיינים...)."
                ],
                definition: "א. המצב הסינופטי בקיץ הוא יציב מאוד וכולל: 1. אפיק פרסי (שלוחה של המונסון ההודי) בקרקע, שגורם לזרימה צפון-מערבית. 2. רמה סובטרופית ברום, שגורמת להתמוככות (שקיעת אוויר), מונעת גשם ויוצרת אינברסיה.\nב. השינויים מיום ליום קטנים מאוד. מזג האוויר כמעט זהה כל יום, והשינוי העיקרי הוא בגובה האינברסיה המארינית, המשפיע על הלחות והטמפרטורה בהרים.\nג. מזג אוויר בחוף: חם ולח מאוד (הביל). טמפרטורות מתונות יחסית (סביב 30 מעלות) אך עם 70-90% לחות. בבקרים עשויה להופיע עננות נמוכה (סטרטוס) שמתפזרת. אין משקעים.",
                explanation: "השילוב של הרמה ברום (ש'לוחצת' מלמעלה) והאפיק בקרקע (שמזרים אוויר לח מהים) יוצר את 'האינברסיה המארינית'. היא זו ש'כולאת' את הלחות וזיהום האוויר במישור החוף, וגורמת להבדל הדרמטי בין החוף הלח להר היבש (כשהאינברסיה נמוכה).",
                tip: "קיץ = אפיק פרסי + רמה ברום = 'מכסה סיר' (אינברסיה). חם, לח, יציב ו...משעמם מטאורולוגית."
            },
            {
                term: "אפיק ים סוף (גרסאות 1+2)",
                questions: [
                    "גרסה 1: א. הסבר/י והשווה/י את תהליכי ההיווצרות של שני המצבים הסינופטיים הללו (פעיל ולא פעיל). אילו תנאים תורמים להופעה של אחד או של השני?",
                    "גרסה 1: ב. פרט/י את תופעות מזג האוויר השכיחות במקרה שנוצר אפיק ים סוף פעיל?",
                    "גרסה 1: ג. פרט/י את תופעות מזג האוויר השכיחות במקרה שנוצר אפיק ים סוף לא פעיל?",
                    "גרסה 2: א. תאר/י את מזג האוויר הצפוי עבור אפיק לא פעיל עם ציר מערבי (טמפ', רוח, עננות...)."
                ],
                definition: "א. אפיק ים סוף (א\"ס) הוא שלוחה של שקע סודני המשתרעת צפונה לאורך ים סוף. \nא\"ס לא פעיל: זהו מצב קרקעי בלבד. אין תמיכה ברום (לרוב יש רכס רום מעל). \nא\"ס פעיל: נוצר כאשר אפיק ים סוף בקרקע נמצא מתחת לאפיק רום. השילוב הזה יוצר 'שאיבה' חזקה, אי-יציבות ועליית אוויר.\nב. א\"ס פעיל: מצב של אי-יציבות חזקה. גורם לענני סערה (Cb), גשמים חזקים ושטפונות, בעיקר בדרום הארץ ובמזרחה.\nג. + ד. א\"ס לא פעיל (ציר מערבי): האפיק ממערב לנו. גורם לרוחות דרום-מזרחיות חמות ויבשות (שרב), אובך וסופות חול.",
                explanation: "יש גם אפיק ים סוף לא פעיל עם ציר מזרחי (שלא נשאלת עליו כאן), הגורם לרוחות צפוניות קרירות יחסית ויובש, אך עם אפשרות לערפילים בחוף בגלל הבריזה.",
                tip: "א\"ס לא פעיל = רק בקרקע = יובש/שרב.\nא\"ס פעיל = קרקע + רום = 'פתוח לשמיים' = אי-יציבות ושטפונות."
            },
            {
                term: "חורף בישראל (גרסאות 1+2)",
                questions: [
                    "גרסה 1: א. כיצד נקראת מערכת מזג האוויר הגורמת לעיקר המשקעים בחורף באזורנו? תארו בקצרה את מאפייניה הסינופטיים.",
                    "גרסה 1: ב. כיצד נוצרת מערכת זו? בתשובתכם התייחסו למאפיינים ברום ובקרקע...",
                    "גרסה 2: ג. תאר/י את מזג האוויר במצב הסינופטי הגשום ביותר מכל אלה שהופיעו בסעיף א."
                ],
                definition: "א. המערכת העיקרית הגורמת למשקעים בחורף היא 'שקע קפריסאי' (שקע חזיתי).\nמאפיינים: שקע ברומטרי (לחץ נמוך) בקרקע, שמרכזו לרוב באזור קפריסין. זהו שקע חזיתי, כלומר יש לו חזית חמה וחזית קרה.\nב. היווצרות: השקע נוצר כתוצאה ממפגש גושי אוויר (קר מצפון, חם מהים) וחשוב מכל, בתמיכה של אפיק רום. אפיק הרום (שקע בגובה) 'שואב' אוויר כלפי מעלה ומאפשר לשקע הקרקעי להיווצר ולהעמיק.\nג. מזג האוויר במעבר השקע (המצב הגשום): \n1. לפני החזית החמה: רוחות דרום-מזרחיות יבשות, מתחיל להתכסות בענני צירוס.\n2. בסקטור החם (בין החזיתות): רוחות דרומיות/דרום-מערביות, חם יחסית, טפטוף.\n3. מעבר החזית הקרה (שיא המזג\"א): חיגת רוח חדה למערבית/צפון-מערבית, ירידה חדה בטמפ', עלייה בלחות, וגשמים חזקים המלווים בענני Cb, סופות רעמים, ברד ורוחות חזקות.",
                explanation: "בנוסף לשקע הקפריסאי, ישנם מצבים רכסיים (רמה) בין השקעים, הגורמים למזג אוויר נאה ויציב, אך לעיתים קריר מאוד (קרה קרינתית).",
                tip: "חורף גשום = שקע קפריסאי. זכרו את הסדר: חזית חמה (מתון) -> סקטור חם -> חזית קרה (ה'בום' הגדול)."
            },
            {
                term: "הסירקולציה הגלובאלית",
                questions: [
                    "א. מהם שלושת תאי הזרימה העולמיים ובאלו קווי רוחב הם קיימים?",
                    "ב. השוו בין האקלים בחלק הדרומי של תא הדלי לבין החלק הצפוני שלו.",
                    "ג. הסבירו את התפקיד של כוח קוריוליס בהיווצרות תאי הצירקולציה."
                ],
                definition: "א. שלושת התאים (בכל חצי כדור): \n1. תא הדלי (Hadley Cell): מקו המשווה (0°) עד קו רוחב 30°.\n2. תא פרל (Ferrel Cell): מקו רוחב 30° עד 60°.\n3. תא פולארי (Polar Cell): מקו רוחב 60° עד הקוטב (90°).\nב. תא הדלי: בחלקו הדרומי (סביב קו המשווה, ITCZ) יש עליית אוויר חם ולח, התכנסות ויצירת עננים וגשמים טרופיים. בחלקו הצפוני (סביב 30°, הרמה הסובטרופית) יש שקיעת אוויר (התמוככות), התחממות, התייבשות ויצירת 'רצועת המדבריות' העולמית.\nג. כוח קוריוליס: לולא כוח קוריוליס, היה תא אחד גדול מהמשווה לקוטב. כוח קוריוליס (הנובע מסיבוב כדוה\"א) מסיט את האוויר ימינה בצפון (ושמאלה בדרום). הוא גורם לאוויר שעולה בקו המשווה וזורם צפונה 'להסתובב' ימינה ולהפוך לרוח מערבית ברום, שנבלמת ושוקעת בקו 30°, ובכך 'שובר' את התא הגדול ויוצר את שלושת התאים.",
                explanation: "הסירקולציה הגלובלית היא 'מערכת ההפעלה' של האקלים. היא זו שמעבירה עודפי חום מהמשווה לקטבים ומכתיבה את אזורי הגשם והמדבר העיקריים בעולם.",
                tip: "תא הדלי: עולה במשווה (ג'ונגל), יורד ב-30° (מדבר).\nקוריוליס = ה'מסובב' הראשי ששובר תא אחד לשלושה."
            },
            {
                term: "המונסון ההודי",
                questions: [
                    "א. הסבירו מהו המונסון ההודי.",
                    "ב. כיצד משפיע המונסון ההודי על עונת הקיץ בישראל?",
                    "ג. מהי המערכת הגלובאלית הנוספת אשר משפיעה על ישראל בקיץ? תארו את השפעתה."
                ],
                definition: "א. המונסון ההודי הוא תופעה עונתית קיצונית הנגרמת מהפרשי טמפרטורה בין יבשת אסיה החמה לאוקיינוס ההודי הקר יחסית. בקיץ, היבשת הלוהטת יוצרת שקע תרמלי עמוק, השואב אוויר לח וחם מהאוקיינוס וגורם לגשמי זעף בהודו ודרום מזרח אסיה.\nב. השפעה על ישראל: השקע המונסוני הענק שולח שלוחה מערבה, המכונה 'האפיק הפרסי'. אפיק זה בקרקע הוא הגורם לזרימה הצפון-מערבית היציבה בישראל בקיץ.\nג. המערכת הנוספת: הרמה הסובטרופית (האזורית). זוהי רמה ברום (לחץ גבוה בגובה) השוקעת מעל אזורנו בקיץ. היא גורמת להתמוככות (שקיעת אוויר), התחממות, וחשוב מכל - היא מייצרת את האינברסיה המארינית, שמונעת גשם ו'כולאת' את הלחות בחוף.",
                explanation: "השילוב של שתי המערכות האלה הוא שקובע את אופי הקיץ הישראלי: האפיק הפרסי (ממזרח) והרמה האזורית (ממערב) 'תופסות' את ישראל ביניהן ויוצרות את הזרימה הצפון-מערבית. הרמה ברום (מלמעלה) דואגת שיהיה יציב וללא גשם.",
                tip: "מונסון = גשם בהודו = שקע ענק.\nשקע ענק -> שולח 'זרוע' (אפיק פרסי) -> נותן לנו רוח צפון-מערבית בקיץ."
            },
            {
                term: "שקע שרבי",
                questions: [
                    "א. הסבירו מהו שקע שרבי, באיזה עונה הוא נוצר ומה הם הגורמים התורמים להיווצרותו?",
                    "ב. אילו תופעות מסוכנות לטיסה נצפה לפגוש במהלך מעבר השקע?",
                    "ג. תארו את מהלך מזג האוויר בחצרים בזמן מעבר השקע השרבי."
                ],
                definition: "א. שקע שרבי (או שקע צפון אפריקאי) הוא שקע חם ויבש הנוצר בעיקר בעונות המעבר (אביב וסתיו). הוא נוצר עקב הפרשי טמפרטורה חריפים בין מדבר סהרה החם לים התיכון הקריר יחסית, ונע במהירות מזרחה לאורך חופי צפון אפריקה.\nב. סכנות לטיסה: 1. רוחות חזקות (במיוחד בסקטור החם). 2. סופות חול ואבק (אובך כבד) הפוגעים קשות בראות ועלולים לגרום נזק למנועים. 3. 'שבירת שרב' - מעבר חד ומהיר של החזית הקרה, המלווה בחיגת רוח חדה, ירידת טמפרטורה פתאומית ומשבי רוח חזקים.\nג. מהלך בחצרים: 1. לפני השקע (בסקטור החם): רוחות מזרחיות/דרום-מזרחיות חזקות, חם מאוד ויבש (שרב), אובך כבד וסופות חול. 2. 'שבירת השרב' (מעבר החזית הקרה): חיגת רוח פתאומית למערבית/צפון-מערבית, ירידה דרמטית בטמפרטורה (10-15 מעלות בשעה), עלייה חדה בלחות, משבי רוח חזקים מאוד, והאובך הכבד הופך ל'אובך לח' (בוץ באוויר) עם ראות גרועה מאוד.",
                explanation: "השקע השרבי שונה משקע קפריסאי בכך שהוא מגיע מדרום-מערב (צפון אפריקה) והוא חם ויבש בבסיסו, בעוד שקע קפריסאי מגיע מצפון-מערב והוא קר ולח.",
                tip: "שרבי = סהרה. שקע שמביא איתו את כל החום והאבק מהמדבר. הסכנה העיקרית: אובך ו'שבירה' פתאומית."
            },
            {
                term: "משקעים",
                questions: [
                    "א. תאר/י בקצרה את תהליך הגידול של טיפונות ענן ליצירת גשם.",
                    "ב. הסבר/הסבירי בקצרה כיצד נוצרים ברד ושלג.",
                    "ג. מהו הקשר בין תהליך ההיווצרות של ברד ושלג לתופעת ההתקרחות במטוסים?"
                ],
                definition: "א. טיפונות ענן זעירות גדלות בשתי דרכים: 1. התנגשות והתלכדות ('גשם חם'): טיפות גדולות נופלות מהר יותר, מתנגשות בטיפות קטנות ו'בולעות' אותן. 2. 'גשם קר' (תהליך ברגרון): בענן קר (מתחת 0°C), גבישי קרח סופחים אליהם אדי מים מהר יותר מטיפות המים בקירור-יתר שסביבם. גבישי הקרח גדלים על חשבון הטיפות, הופכים כבדים, נופלים ומפשירים בדרכם למטה.\nב. שלג: נוצר בתהליך 'גשם קר', כאשר גבישי הקרח גדלים מספיק ונופלים, אך הטמפרטורה בכל שכבת האוויר (מהענן עד הקרקע) נשארת מתחת לאפס, ולכן הם לא מפשירים.\nברד: נוצר בענני סערה (Cb) עם זרמים אנכיים חזקים. גביש קרח נזרק מעלה ומטה בתוך הענן, אוסף עליו שכבות של מים בקירור-יתר שקופאות עליו. הוא גדל עד שהוא כבד מספיק כדי להתגבר על הזרם העולה וליפול.\nג. הקשר להתקרחות: גם ברד, גם שלג וגם התקרחות דורשים נוכחות של מים בקירור-יתר (טיפות מים נוזליות בטמפרטורה מתחת 0°C). מטוס שטס דרך ענן כזה משמש כ'גרעין קיפאון' ענק, והטיפות בקירור-יתר קופאות עליו ויוצרות התקרחות.",
                explanation: "התקרחות היא למעשה 'ברד' שנוצר על כנף המטוס במקום בתוך הענן.",
                tip: "המרכיב הסודי לרוב המשקעים וההתקרחות הוא 'מים בקירור-יתר' - טיפות מים מבולבלות שלא יודעות שהן צריכות לקפוא."
            },
            {
                term: "עונות השנה בכדור הארץ ובארץ ישראל",
                questions: [
                    "א. מהי הסיבה להיווצרותן של עונות השנה בכדור הארץ?",
                    "ב. תאר/י בקצרה שתי מערכות סינופטיות הפוקדות את ישראל בעונות המעבר.",
                    "ג. פרטו והסבירו את התופעות מסוכנות לטיסה בהן אנו עלולים להיתקל באחת המערכות."
                ],
                definition: "א. הסיבה לעונות השנה היא נטיית ציר הסיבוב של כדור הארץ ב-23.5 מעלות יחסית למישור המילקה (המישור בו הוא מקיף את השמש). נטייה זו גורמת לכך שבמהלך השנה, כל חצי כדור 'נוטה' לכיוון השמש (ומקבל קרינה ישירה - קיץ) או 'הרחק' מהשמש (ומקבל קרינה בזווית נמוכה - חורף).\nב. מערכות בעונות המעבר (אביב/סתיו): 1. שקע שרבי: שקע חם ויבש המגיע מצפון אפריקה. 2. אפיק ים סוף (פעיל או לא פעיל): שלוחת שקע מאזור סודן.\nג. סכנות לטיסה בשקע שרבי: רוחות חזקות, סופות חול ואבק (אובך) הפוגעים קשות בראות ובמנועים, ו'שבירת שרב' פתאומית עם גזירות רוח חזקות.",
                explanation: "בניגוד לתפיסה נפוצה, עונות השנה *לא* נגרמות בגלל שינוי המרחק מהשמש. למעשה, בחצי הכדור הצפוני, החורף מתרחש כשאנו קרובים יותר לשמש (פריהליון).",
                tip: "עונות = נטייה (Axis Tilt). לא מרחק! זווית השמש היא שקובעת. \nעונות מעבר = 'בלאגן' סינופטי. בעיקר שרב (אבק) ואפיק ים סוף (יובש או שטפונות)."
            },
            {
                term: "שקע קפריסאי",
                questions: [
                    "א. תארו את מזג האוויר הצפוי לפני מעבר החזית החמה ולאחריה (טמפ, רוח, עננות...).",
                    "ב. תארו את מזג האוויר הצפוי עם מעבר החזית הקרה (טמפ, רוח, עננות...).",
                    "ג. מהן הסכנות לטיסה שנצפה לפגוש בבסיס חצרים במהלך מעבר השקע? וברמת דוד?"
                ],
                definition: "א. לפני חזית חמה: רוחות דרום-מזרחיות (יבשות וקרות מהיבשה), טמפ' נמוכות, שמיים מתכסים בהדרגה בעננות גבוהה ובינונית (צירוס, אלטוסטרטוס).\nאחרי חזית חמה (בסקטור החם): רוחות דרומיות/דרום-מערביות (חמות ולחות מהים), טמפ' עולה, לחות עולה, עננות נמוכה (סטרטוס) וטפטופים.\nב. מעבר חזית קרה: זהו שיא האירוע. חיגת רוח חדה למערבית/צפון-מערבית, ירידה חדה בטמפ', משבי רוח חזקים, עלייה חדה בלחות, והתפתחות עננות ערמתית (Cb) עם גשמים חזקים, סופות רעמים וברד.\nג. סכנות לטיסה: 1. בחזית הקרה: כל סכנות ה-Cb (ברד, ברקים, התקרחות, גזירת רוח). 2. בסקטור החם: עננות נמוכה (סטרטוס) המגבילה ראות בנחיתה. 3. סופות חול: לעיתים, הרוחות הדרומיות בסקטור החם חזקות ומביאות אובך וסופות חול לדרום (חצרים). הסכנות בחצרים (דרום) דומות לרמת דוד (צפון), אך האירוע מגיע לחצרים מאוחר יותר, לרוב חלש יותר, ועם יותר סיכוי לאבק.",
                explanation: "שקע קפריסאי הוא השקע החזיתי הקלאסי של החורף הישראלי, והוא נע ממערב למזרח.",
                tip: "קפריסאי = חורף. זכרו את הסדר: חמה (שטיח עננים) -> סקטור חם (טפטוף) -> קרה (ה'בום' הגדול עם Cb)."
            },
            {
                term: "מצבים רכסיים",
                questions: [
                    "א. הסבירו מהי רמה/רכס וכיצד יזרום בה האוויר.",
                    "ב. ציינו שתי מערכות של רכס/רמה האופייניות לישראל.",
                    "ג. בהתייחס לשתי המערכות שציינתם בסעיף א'- מה תהיה הרוח בישראל בכל אחת אחת מהן? מה יהיו מאפייני האוויר במצב זה? (מבחינת לחות, טמפ')."
                ],
                definition: "א. רמה/רכס הוא אזור שבו לחץ האוויר גבוה ביחס לסביבתו. אוויר ברום שוקע (מתמוכך) למרכז הרמה, מתחמם ומתייבש. בקרקע, האוויר זורם ממרכז הרמה החוצה (מתבדר) עם כיוון השעון (בחצי הכדור הצפוני).\nב. מערכות רכס לישראל: 1. רמה אזורית (חלק מהרמה הסובטרופית) - בעיקר בקיץ (ברום) ובין שקעים בחורף (בקרקע). 2. רמה סיבירית - שלוחה של רמה קרה מאוד ממרכז אסיה, מגיעה בחורף.\nג. רמה אזורית (בין שקעים): גורמת למזג אוויר נאה ויציב. רוחות צפוניות/צפון-מערביות קלות. האוויר יבש וקריר, אך מאפשר התקררות קרינתית חזקה בלילה (יצירת ערפל וקרה).\nרמה סיבירית: גורמת להתקררות קיצונית. רוחות צפוניות-מזרחיות (מזרחיות), יבשות וקרות מאוד. מזג אוויר בהיר, יציב וקר מאוד (קרה חמורה).",
                explanation: "רכס הוא 'אח של' רמה, כמו שאפיק הוא 'אח של' שקע. רמה היא 'בועת' לחץ גבוה, רכס הוא 'שלוחה' של לחץ גבוה.",
                tip: "רמה = 'רם' (גבוה). לחץ גבוה. אוויר יורד מלמעלה (מתמוכך), מתחמם ומתייבש -> מזג אוויר יציב ובהיר."
            },
            {
                term: "ערפל קרינה וערפל הרים",
                questions: [
                    "א. הסבר/י והשווה/י את תהליכי ההיווצרות של שני סוגי הערפל. באילו אזורים בארץ נצפה לראות כל סוג ערפל?",
                    "ב. ציין/ני שני תנאים החייבים להתקיים להיווצרות כל אחד מסוגי הערפל. הסבר/י מדוע תנאים אלו הכרחיים.",
                    "ג. ישנה אמרה הגורסת כי לא ניתן לקבל ערפל וסופת רעמים בו זמנית באותו המקום. תן/ני דוגמא לסוג ערפל עבורו אימרה זו נכונה, ודוגמא לסוג ערפל עבורו האימרה אינה נכונה. הסבר/י את תשובתך."
                ],
                definition: "א. ערפל קרינה: נוצר בלילות בהירים, קרים וללא רוח. הקרקע פולטת קרינה ומתקררת מאוד, ומקררת את שכבת האוויר שמעליה (בהולכה) אל מתחת לנקודת הטל. זהו ערפל 'מקומי'. נפוץ בעמקים ומישורים פנימיים (למשל עמק יזרעאל, צפון הנגב).\nערפל הרים (ערפל אורוגרפי): זהו פשוט ענן (לרוב סטרטוס) שבסיסו נמוך מפסגת ההר. האוויר נאלץ לעלות במעלה ההר, מתקרר אדיאבטית ומגיע לרוויה. נפוץ בפסגות ההרים (הרי יהודה, גליל, כרמל).\nב. ערפל קרינה: 1. לילה בהיר (לקרינה לברוח). 2. רוח חלשה (כדי שהאוויר הקר יישאר צמוד לקרקע ולא יתערבב). \nערפל הרים: 1. אוויר לח. 2. רוח יציבה בכיוון ההר (כדי 'לדחוף' את האוויר במעלה).\nג. אמרה זו נכונה לערפל קרינה: סופת רעמים דורשת אי-יציבות קיצונית (אוויר עולה), בעוד ערפל קרינה דורש יציבות מוחלטת (אוויר קר שוקע). אלו תנאים הפוכים. \nהאמרה אינה נכונה לערפל הרים: בהחלט ייתכן מצב שבו ענן סערה (Cb) מפותח מגיע לפסגת הר ו'עוטף' אותה. אדם על הפסגה יחווה ערפל כבד (הוא בתוך הענן) ובו זמנית סופת רעמים.",
                explanation: "ההבדל המהותי: ערפל קרינה נוצר מהתקררות במקום (הקרקע מקררת), ערפל הרים נוצר מתנועה (אוויר עולה ומתקרר).",
                tip: "קרינה = קור מהקרקע. הרים = ענן ש'נתקע' בהר."
            }
        ];


        let currentQuestionIndex = 0;
        let shuffledQuizData = [];
        let isEvaluating = false;

        // רכיבי DOM
        const quizContainer = document.getElementById('quiz-container');
        const completionScreen = document.getElementById('completion-screen');
        const questionCounter = document.getElementById('question-counter');
        const termEl = document.getElementById('term');
        const subQuestionsEl = document.getElementById('sub-questions');
        const userAnswerEl = document.getElementById('user-answer');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedbackContainer = document.getElementById('feedback-container');
        const loader = document.getElementById('loader');
        const feedbackEl = document.getElementById('feedback');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const correctAnswerContainer = document.getElementById('correct-answer-container');
        const correctAnswerEl = document.getElementById('correct-answer');
        const definitionEl = document.getElementById('definition');
        const explanationEl = document.getElementById('explanation');
        const tipEl = document.getElementById('tip');
        const questionIndexContainer = document.getElementById('question-index');
        const standaloneNav = document.getElementById('standalone-nav');

        const STORAGE_KEY = 'open_quiz_state_v1';
        let shuffledOrder = [];
        let questionStates = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (window.self === window.top) {
                standaloneNav.classList.remove('hidden');
            }
            startQuiz();
        });

        function createEmptyState() {
            return { answer: '', feedback: '', showAnswer: false, status: 'unanswered' };
        }

        function loadSavedState() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) {
                    return null;
                }

                const parsed = JSON.parse(stored);
                if (!Array.isArray(parsed.order) || parsed.order.length !== quizData.length) {
                    localStorage.removeItem(STORAGE_KEY);
                    return null;
                }

                if (!Array.isArray(parsed.questionStates) || parsed.questionStates.length !== quizData.length) {
                    localStorage.removeItem(STORAGE_KEY);
                    return null;
                }

                if (!parsed.order.every(idx => Number.isInteger(idx) && idx >= 0 && idx < quizData.length)) {
                    localStorage.removeItem(STORAGE_KEY);
                    return null;
                }

                const sanitizedStates = parsed.questionStates.map(state => ({
                    answer: typeof state?.answer === 'string' ? state.answer : '',
                    feedback: typeof state?.feedback === 'string' ? state.feedback : '',
                    showAnswer: Boolean(state?.showAnswer),
                    status: state?.status === 'done' ? 'done' : 'unanswered'
                }));

                const savedIndex = Number.isInteger(parsed.currentQuestionIndex) ? parsed.currentQuestionIndex : 0;

                return {
                    order: parsed.order.slice(),
                    questionStates: sanitizedStates,
                    currentQuestionIndex: Math.min(Math.max(savedIndex, 0), quizData.length - 1),
                    completed: Boolean(parsed.completed)
                };
            } catch (error) {
                console.warn('Failed to load saved quiz state', error);
                return null;
            }
        }

        function saveState(extra = {}) {
            try {
                const payload = {
                    order: shuffledOrder,
                    questionStates,
                    currentQuestionIndex,
                    completed: extra.completed !== undefined ? extra.completed : !completionScreen.classList.contains('hidden')
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
            } catch (error) {
                console.warn('Failed to save quiz state', error);
            }
        }

        function clearSavedState() {
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (error) {
                console.warn('Failed to clear quiz state', error);
            }
        }

        function renderQuestionIndex() {
            questionIndexContainer.innerHTML = '';
            shuffledQuizData.forEach((_, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = index + 1;
                button.className = 'question-index-btn';
                button.addEventListener('click', () => goToQuestion(index));
                questionIndexContainer.appendChild(button);
            });
        }

        function updateQuestionIndex() {
            const buttons = questionIndexContainer.querySelectorAll('button');
            buttons.forEach((btn, idx) => {
                btn.classList.remove('is-active', 'is-in-progress', 'is-answered');
                if (idx === currentQuestionIndex) {
                    btn.classList.add('is-active');
                }
                const state = questionStates[idx];
                if (!state) {
                    return;
                }
                if (state.status === 'done') {
                    btn.classList.add('is-answered');
                } else if (state.status === 'in-progress') {
                    btn.classList.add('is-in-progress');
                }
            });
        }

        function goToQuestion(index) {
            if (isEvaluating) {
                return;
            }
            currentQuestionIndex = index;
            loadQuestion();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz(reset = false) {
            let savedState = null;
            if (!reset) {
                savedState = loadSavedState();
            }

            if (savedState) {
                shuffledOrder = savedState.order.slice();
                shuffledQuizData = shuffledOrder.map(idx => quizData[idx]);
                questionStates = savedState.questionStates;
                currentQuestionIndex = savedState.currentQuestionIndex;
                isEvaluating = false;
                quizContainer.classList.toggle('hidden', savedState.completed);
                completionScreen.classList.toggle('hidden', !savedState.completed);
                renderQuestionIndex();
                if (savedState.completed) {
                    updateQuestionIndex();
                    saveState({ completed: true });
                } else {
                    loadQuestion();
                }
                return;
            }

            shuffledOrder = shuffleArray(Array.from({ length: quizData.length }, (_, idx) => idx));
            shuffledQuizData = shuffledOrder.map(idx => quizData[idx]);
            questionStates = shuffledQuizData.map(() => createEmptyState());
            currentQuestionIndex = 0;
            isEvaluating = false;
            quizContainer.classList.remove('hidden');
            completionScreen.classList.add('hidden');
            renderQuestionIndex();
            loadQuestion();
            saveState();
        }

        function loadQuestion() {
            updateQuestionIndex();

            if (currentQuestionIndex >= shuffledQuizData.length) {
                quizContainer.classList.add('hidden');
                completionScreen.classList.remove('hidden');
                saveState({ completed: true });
                return;
            }

            const question = shuffledQuizData[currentQuestionIndex];
            const state = questionStates[currentQuestionIndex];

            termEl.textContent = question.term;
            questionCounter.textContent = `שאלה ${currentQuestionIndex + 1} / ${shuffledQuizData.length}`;

            subQuestionsEl.innerHTML = '';
            question.questions.forEach(q => {
                const p = document.createElement('p');
                p.textContent = q;
                subQuestionsEl.appendChild(p);
            });

            userAnswerEl.value = state.answer || '';
            loader.classList.add('hidden');

            if (state.status === 'done') {
                userAnswerEl.disabled = true;
                feedbackContainer.classList.remove('hidden');
                feedbackEl.textContent = state.feedback;
                submitBtn.classList.add('hidden');
                submitBtn.disabled = false;
                nextBtn.classList.remove('hidden');
                nextBtn.textContent = currentQuestionIndex === shuffledQuizData.length - 1 ? 'סיום הבוחן' : 'השאלה הבאה';
                correctAnswerContainer.classList.remove('hidden');
                if (state.showAnswer) {
                    correctAnswerEl.classList.remove('hidden');
                    showAnswerBtn.textContent = 'הסתר תשובה מלאה';
                    definitionEl.textContent = question.definition;
                    explanationEl.textContent = question.explanation;
                    tipEl.textContent = question.tip;
                } else {
                    correctAnswerEl.classList.add('hidden');
                    showAnswerBtn.textContent = 'הצג תשובה מלאה';
                }
            } else {
                userAnswerEl.disabled = false;
                feedbackContainer.classList.add('hidden');
                feedbackEl.textContent = '';
                submitBtn.classList.remove('hidden');
                submitBtn.disabled = false;
                nextBtn.classList.add('hidden');
                correctAnswerContainer.classList.add('hidden');
                correctAnswerEl.classList.add('hidden');
                showAnswerBtn.textContent = 'הצג תשובה מלאה';
                if (state.status === 'in-progress') {
                    feedbackContainer.classList.remove('hidden');
                    feedbackEl.textContent = 'Gemini חושב על המשוב שלך...';
                }
            }

            saveState();
        }

        function submitAnswer() {
            if (isEvaluating) {
                return;
            }

            const userAnswer = userAnswerEl.value;
            const correctDefinition = shuffledQuizData[currentQuestionIndex].definition;

            if (userAnswer.trim() === '') {
                feedbackEl.textContent = 'אנא הזן/י תשובה.';
                feedbackContainer.classList.remove('hidden');
                feedbackEl.classList.remove('hidden');
                loader.classList.add('hidden');
                return;
            }

            const state = questionStates[currentQuestionIndex];
            state.answer = userAnswer;
            state.feedback = '';
            state.showAnswer = false;
            state.status = 'in-progress';

            isEvaluating = true;
            updateQuestionIndex();
            saveState();

            feedbackContainer.classList.remove('hidden');
            feedbackEl.textContent = 'Gemini חושב על המשוב שלך...';
            loader.classList.remove('hidden');
            submitBtn.disabled = true;
            userAnswerEl.disabled = true;
            correctAnswerContainer.classList.add('hidden');
            correctAnswerEl.classList.add('hidden');
            showAnswerBtn.textContent = 'הצג תשובה מלאה';

            checkWithGemini(userAnswer, correctDefinition);
        }

        function showAnswer() {
            const state = questionStates[currentQuestionIndex];
            const isHidden = correctAnswerEl.classList.toggle('hidden');
            state.showAnswer = !isHidden;
            showAnswerBtn.textContent = isHidden ? 'הצג תשובה מלאה' : 'הסתר תשובה מלאה';

            if (!isHidden) {
                const question = shuffledQuizData[currentQuestionIndex];
                definitionEl.textContent = question.definition;
                explanationEl.textContent = question.explanation;
                tipEl.textContent = question.tip;
            }

            saveState();
        }

        function nextQuestion() {
            if (isEvaluating) {
                return;
            }
            currentQuestionIndex++;
            loadQuestion();
        }

        function restartQuiz() {
            if (isEvaluating) {
                return;
            }
            clearSavedState();
            shuffledOrder = [];
            startQuiz(true);
        }

        // --- לוגיקת Gemini API ---

        // יש להשאיר את המפתח ריק. המערכת תזריק את המפתח הנכון בזמן ריצה.
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // פונקציה לטיפול ב-Backoff
        async function handleRetry(url, options, n = 3, delay = 1000) {
            try {
                return await fetch(url, options);
            } catch (err) {
                if (n === 1) throw err;
                await new Promise(resolve => setTimeout(resolve, delay));
                return await handleRetry(url, options, n - 1, delay * 2);
            }
        }

        async function checkWithGemini(userAnswer, correctDefinition) {
            const state = questionStates[currentQuestionIndex];
            // פרומפט מערכת מותאם לבקשת המשתמש (עד 3 משפטים)
            const systemPrompt = "א.אתה עוזר לי ללמוד מטאורולוגיה למבחן עם שאלות פתוחות.התשובה שלי היא תשובה חופשית. השווה את התשובה שלי להגדרה בחומר הלימוד שלי. תן משוב קצר רק בעברית (שלושה משפטים מקסימום!) המתמקד בכיצד לשפר את התשובה ולהפוך אותה למושלמת. התמקד בחלקים החסרים או הלא מדויקים בתשובה שלי והאם הבנתי את העיקרון המרכזי. אם התשובה מצוינת, תן חיזוק חיובי. דבר רק בעברית ורק עד שלושה משפטים אל תיתן את הדרך חשיבה שלך אל תגרום לבעיות מדיניות ";

            const userPrompt = `
                השאלה: "${shuffledQuizData[currentQuestionIndex].term}"
                בחומר לימוד כתוב: "${correctDefinition}"
                ---
                התשובה שלי: "${userAnswer}"
                ---
                מה המשוב שלך (בעברית, עד 3 משפטים):
            `;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    maxOutputTokens: 500 // כפי שביקשת
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await handleRetry(apiUrl, options);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error("API Error Response:", errorData);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error?.message || response.statusText}`);
                }

                const result = await response.json();
                console.log("Gemini API Response:", result);

                const candidate = result.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text;

                if (text) {
                    loader.classList.add('hidden');
                    state.feedback = text.trim();
                } else {
                    let errorMsg = "לא הצלחתי לעבד את התשובה, אנא נסה שוב.";
                    const blockReason = candidate?.finishReason || result.promptFeedback?.blockReason;
                    if (blockReason) {
                        console.warn("Gemini block reason:", blockReason);
                        errorMsg = "התשובה נחסמה עקב מדיניות בטיחות. נסה/י לנסח מחדש.";
                    } else if (!candidate) {
                        console.warn("No candidates in API response.", result);
                        errorMsg = "המודל לא החזיר תשובה. נסה/י שוב.";
                    }
                    loader.classList.add('hidden');
                    state.feedback = errorMsg;
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                loader.classList.add('hidden');
                state.feedback = "אירעה שגיאת רשת בבדיקת התשובה. אנא בדוק את התשובה המלאה.";
            } finally {
                state.status = 'done';
                isEvaluating = false;
                feedbackContainer.classList.remove('hidden');
                loader.classList.add('hidden');
                submitBtn.disabled = false;
                userAnswerEl.disabled = true;
                updateQuestionIndex();
                loadQuestion();
            }
        }

    </script>
</body>

</html>
